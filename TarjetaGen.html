<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio de Diseño de Tarjetas Avanzado</title>
    
    <!-- FUENTES DE GOOGLE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Dancing+Script:wght@700&family=Lato:ital,wght@0,400;1,400&family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <!-- LIBRERÍAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --color-oro: #BFA17A; 
            --color-oro-claro: #D1BBA3;
            --color-fondo: #F9F5EF;
            --color-texto: #4B4B4B; 
            --color-sombra: rgba(0, 0, 0, 0.07); 
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f2ef; margin: 0; padding: 2rem; color: var(--color-texto); display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .studio-container { display: grid; grid-template-columns: 380px 1fr; gap: 2.5rem; max-width: 1300px; width: 100%; background: white; padding: 2.5rem; border-radius: 15px; box-shadow: 0 10px 40px var(--color-sombra); }
        .controls-panel { padding-right: 1.5rem; max-height: 85vh; overflow-y: auto; padding-left: 5px;}
        .controls-panel h1 { font-family: 'Playfair Display', serif; color: #333; margin-top: 0; font-size: 2.2rem; }
        
        details { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem; }
        summary { font-weight: bold; cursor: pointer; padding: 0.75rem; background-color: #f9f9f9; border-radius: 8px; color: var(--color-oro); }
        details[open] summary { border-bottom: 1px solid #e0e0e0; }
        .details-content { padding: 1rem; }

        .control-group { margin-bottom: 1.5rem; position: relative; }
        .control-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #555; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; background: #fff; }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus { outline: none; border-color: var(--color-oro); box-shadow: 0 0 8px rgba(191, 161, 122, 0.4); }
        
        .size-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        textarea { height: 80px; resize: vertical; }
        .style-selector { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .style-selector button, .format-buttons button { font-family: 'Segoe UI', sans-serif; background: #f9f9f9; border: 1px solid #ddd; padding: 0.6rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; }
        .style-selector button.active, .format-buttons button.active { background-color: var(--color-oro); color: white; border-color: var(--color-oro); font-weight: 600; }
        .format-controls { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; }
        .format-buttons { display: flex; gap: 0.5rem; }
        .format-buttons button { padding: 0.5rem; width: 38px; text-align: center; font-weight: bold; }
        input[type="color"] { width: 38px; height: 38px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; padding: 2px; }
        
        .action-buttons { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; }
        .action-buttons button { flex: 1 1 100%; color: white; border: none; padding: 1rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        #downloadBtn { background-image: linear-gradient(45deg, #28a745, #248a38); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2); }
        #printBtn { background-image: linear-gradient(45deg, #007bff, #0056b3); box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2); }
        #pdfBtn { background-image: linear-gradient(45deg, #dc3545, #b02a37); box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2); }

        .utility-buttons button { flex-basis: 45%; background-color: #6c757d; }
        .utility-buttons button:hover { background-color: #5a6268; }
        
        #search-results { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 100; }
        .search-result-item { display: flex; align-items: center; padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .result-image { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 0.75rem; }
        .result-text { font-size: 0.9rem; font-family: 'Segoe UI', sans-serif; }

        .preview-panel { display: flex; justify-content: center; align-items: center; background-color: #f0f0f0; border-radius: 10px; padding: 2rem; }
        #image-canvas { background-color: var(--color-fondo); display: flex; justify-content: center; align-items: center; box-sizing: border-box; box-shadow: 0 5px 25px var(--color-sombra); position: relative; overflow: hidden; transition: all 0.4s ease-in-out; padding: 10%; background-size: cover; background-position: center; }
        #text-container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-sizing: border-box; z-index: 2; position: relative; transition: transform 0.3s ease; }
        #title-display, #body-display { color: var(--color-texto); transition: all 0.3s ease; }
        #title-display { margin-bottom: 1rem; line-height: 1.2; }
        #body-display { line-height: 1.6; white-space: pre-wrap; margin: 0 auto; }
        .text-on-dark { color: #FFFFFF !important; text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5); }
        #watermark-logo { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('logoblanco.jpg'); background-position: center; background-repeat: no-repeat; z-index: 1; transition: all 0.5s ease; }
        
        .frame-clasico { background-color: var(--color-fondo); border: 1px solid var(--color-oro-claro); }
        .frame-clasico::before { content: ''; position: absolute; top: 25px; left: 25px; right: 25px; bottom: 25px; border: 2px solid var(--color-oro); z-index: 0; background: transparent; }
        .frame-artistico { background-color: var(--color-fondo); border: 1px solid var(--color-oro-claro); }
        .frame-artistico::before, .frame-artistico::after { content: ''; position: absolute; width: 60px; height: 60px; border-color: var(--color-oro); border-style: solid; z-index: 0; background: transparent; }
        .frame-artistico::before { top: 30px; left: 30px; border-width: 3px 0 0 3px; }
        .frame-artistico::after { bottom: 30px; right: 30px; border-width: 0 3px 3px 0; }
        .frame-negro { background-color: white; border: none; }
        .frame-negro::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('images/marco.png'); background-size: cover; background-position: center; background-repeat: no-repeat; z-index: 0; }

        #print-area { display: none; }
        @media print { /* Estilos de impresión... */ }
        @media (max-width: 900px) { /* Estilos responsivos... */ }
    </style>
</head>
<body>
    <div class="studio-container">
        <div class="controls-panel">
            <h1>Diseña tu Tarjeta</h1>
            
            <div class="action-buttons utility-buttons">
                 <button id="saveBtn">💾 Guardar Diseño</button>
                 <button id="loadBtn">📂 Cargar Diseño</button>
            </div>

            <details open>
                <summary>1. Contenido y Estilo</summary>
                <div class="details-content">
                    <div class="control-group">
                        <label for="product-search">Buscar Producto (Opcional)</label>
                        <input type="text" id="product-search" placeholder="Cargando productos...">
                        <div id="search-results"></div>
                    </div>
                    <div class="control-group">
                        <label for="style-select">Elige un Estilo</label>
                        <div class="style-selector" id="style-select">
                            <button class="active" data-style="frame-clasico">Dorado Clásico</button>
                            <button data-style="frame-artistico">Marco Artístico</button>
                            <button data-style="frame-negro">Marco Negro</button>
                        </div>
                    </div>
                    <div class="control-group">
                         <label for="bgImageUpload">Subir Fondo Personalizado</label>
                         <input type="file" id="bgImageUpload" accept="image/*">
                    </div>
                     <div class="control-group">
                        <label for="titleInput">Título</label>
                        <input type="text" id="titleInput" placeholder="Un Regalo Especial">
                    </div>
                    <div class="control-group">
                        <label for="bodyInput">Mensaje</label>
                        <textarea id="bodyInput">Este producto fue preparado con especial cuidado para ti.</textarea>
                    </div>
                </div>
            </details>

            <details>
                <summary>2. Ajustes de Texto Avanzados</summary>
                 <div class="details-content">
                    <div class="control-group">
                         <label>Fuente del Título</label>
                         <select id="titleFont">
                            <option value="'Playfair Display', serif">Playfair Display</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Lato', sans-serif">Lato</option>
                            <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                            <option value="'Dancing Script', cursive">Dancing Script</option>
                         </select>
                         <label style="margin-top: 0.5rem;">Formato</label>
                         <div class="format-controls">
                            <div class="format-buttons" id="title-format">
                                <button data-style="textAlign" data-value="left">L</button>
                                <button data-style="textAlign" data-value="center" class="active">C</button>
                                <button data-style="textAlign" data-value="right">R</button>
                                <button data-style="fontWeight" data-value="bold"><b>B</b></button>
                                <button data-style="fontStyle" data-value="italic"><i>I</i></button>
                            </div>
                            <input type="color" id="titleColor" value="#4B4B4B">
                         </div>
                         <label for="titleFontSizeSlider">Tamaño</label>
                         <input type="range" id="titleFontSizeSlider" min="20" max="80" value="32">
                    </div>
                     <hr>
                    <div class="control-group">
                         <label>Fuente del Mensaje</label>
                         <select id="bodyFont">
                             <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                             <option value="'Lato', sans-serif">Lato</option>
                             <option value="'Montserrat', sans-serif">Montserrat</option>
                             <option value="'Playfair Display', serif">Playfair Display</option>
                             <option value="'Dancing Script', cursive">Dancing Script</option>
                         </select>
                         <label style="margin-top: 0.5rem;">Formato</label>
                         <div class="format-controls">
                             <div class="format-buttons" id="body-format">
                                <button data-style="textAlign" data-value="left">L</button>
                                <button data-style="textAlign" data-value="center" class="active">C</button>
                                <button data-style="textAlign" data-value="right">R</button>
                                <button data-style="fontWeight" data-value="bold"><b>B</b></button>
                                <button data-style="fontStyle" data-value="italic"><i>I</i></button>
                             </div>
                             <input type="color" id="bodyColor" value="#4B4B4B">
                         </div>
                         <label for="bodyFontSizeSlider">Tamaño</label>
                         <input type="range" id="bodyFontSizeSlider" min="14" max="50" value="22">
                    </div>
                     <hr>
                    <div class="control-group">
                        <label for="textPosSlider">Posición Vertical</label>
                        <input type="range" id="textPosSlider" min="-50" max="50" value="0">
                        
                        <!-- NUEVO CONTROL DE ANCHO -->
                        <label for="textWidthSlider" style="margin-top: 1rem;">Ancho del Bloque de Texto</label>
                        <input type="range" id="textWidthSlider" min="80" max="110" value="100">
                    </div>
                     <div class="action-buttons utility-buttons">
                        <button id="resetStylesBtn">🔄 Restablecer Estilos</button>
                     </div>
                 </div>
            </details>
            
            <details>
                <summary>3. Salida y Exportación</summary>
                <div class="details-content">
                    <div class="control-group">
                        <label>Tamaño de la Tarjeta (cm)</label>
                        <div class="size-inputs">
                            <input type="number" id="cardWidth" value="10" min="1">
                            <input type="number" id="cardHeight" value="10" min="1">
                        </div>
                    </div>
                     <div class="control-group">
                        <label for="paperSize">Tamaño de Papel</label>
                        <select id="paperSize">
                            <option value="letter">Carta (8.5 x 11 in)</option>
                            <option value="a4">A4 (210 x 297 mm)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="checkbox-label"><input type="checkbox" id="watermarkToggle" checked>Añadir logo</label>
                        <label for="watermarkOpacitySlider">Opacidad del Logo</label>
                        <input type="range" id="watermarkOpacitySlider" min="0" max="100" value="15">
                        <label for="watermarkSizeSlider">Tamaño del Logo</label>
                        <input type="range" id="watermarkSizeSlider" min="20" max="100" value="60">
                    </div>
                    <div class="action-buttons">
                        <button id="downloadBtn">🖼️ Descargar PNG</button>
                        <button id="pdfBtn">📄 Exportar PDF</button>
                        <button id="printBtn">🖨️ Imprimir</button>
                    </div>
                </div>
            </details>
        </div>
        <div class="preview-panel">
            <div id="image-canvas" class="frame-clasico watermark-active">
                <div id="watermark-logo"></div>
                <div id="text-container">
                    <div id="title-display"></div>
                    <div id="body-display"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="print-area"></div>

    <script>
    (() => {
        const imageCanvas = document.getElementById('image-canvas');
        const textContainer = document.getElementById('text-container');
        const titleDisplay = document.getElementById('title-display');
        const bodyDisplay = document.getElementById('body-display');
        const watermarkLogo = document.getElementById('watermark-logo');
        const productSearch = document.getElementById('product-search');
        const searchResults = document.getElementById('search-results');
        const styleSelector = document.getElementById('style-select');
        const bgImageUpload = document.getElementById('bgImageUpload');
        const titleInput = document.getElementById('titleInput');
        const bodyInput = document.getElementById('bodyInput');
        const titleFont = document.getElementById('titleFont');
        const bodyFont = document.getElementById('bodyFont');
        const titleFormat = document.getElementById('title-format');
        const bodyFormat = document.getElementById('body-format');
        const titleColorPicker = document.getElementById('titleColor');
        const bodyColorPicker = document.getElementById('bodyColor');
        const titleFontSizeSlider = document.getElementById('titleFontSizeSlider');
        const bodyFontSizeSlider = document.getElementById('bodyFontSizeSlider');
        const textPosSlider = document.getElementById('textPosSlider');
        const textWidthSlider = document.getElementById('textWidthSlider'); // Nuevo control
        const watermarkToggle = document.getElementById('watermarkToggle');
        const watermarkOpacitySlider = document.getElementById('watermarkOpacitySlider');
        const watermarkSizeSlider = document.getElementById('watermarkSizeSlider');
        const cardWidthInput = document.getElementById('cardWidth');
        const cardHeightInput = document.getElementById('cardHeight');
        const paperSize = document.getElementById('paperSize');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const resetStylesBtn = document.getElementById('resetStylesBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const pdfBtn = document.getElementById('pdfBtn');
        const printBtn = document.getElementById('printBtn');

        let productosData = [];
        const DEFAULT_TEXT_COLOR = '#4B4B4B';
        const LIGHT_TEXT_COLOR = '#FFFFFF';

        function updatePreview() {
            const fullTitle = titleInput.value;
            const words = fullTitle.trim().split(/\s+/);

            if (words.length > 2) { 
                const lastWord = words.pop();
                const secondLastWord = words.pop();
                const mainPart = words.join(' ');
                titleDisplay.innerHTML = `${mainPart}<br>${secondLastWord} ${lastWord}`;
            } else {
                titleDisplay.innerHTML = fullTitle.replace(/\n/g, "<br>");
            }
            bodyDisplay.innerText = bodyInput.value;

            Object.assign(titleDisplay.style, { fontSize: `${titleFontSizeSlider.value}px`, color: titleColorPicker.value, fontFamily: titleFont.value });
            Object.assign(bodyDisplay.style, { fontSize: `${bodyFontSizeSlider.value}px`, color: bodyColorPicker.value, fontFamily: bodyFont.value });
            
            // Aplicar ancho a ambos elementos de texto
            const newWidth = textWidthSlider.value;
            titleDisplay.style.width = `${newWidth}%`;
            bodyDisplay.style.width = `${newWidth}%`;

            textContainer.style.transform = `translateY(${textPosSlider.value}%)`;
            watermarkLogo.style.opacity = watermarkOpacitySlider.value / 100;
            watermarkLogo.style.backgroundSize = `${watermarkSizeSlider.value}%`;
            
            updatePreviewSize();
        }

        function updatePreviewSize() {
            const aspect = (parseFloat(cardWidthInput.value) || 10) / (parseFloat(cardHeightInput.value) || 10);
            const maxWidth = 550;
            imageCanvas.style.width = `${maxWidth}px`;
            imageCanvas.style.height = `${maxWidth / aspect}px`;
        }
        
        const liveUpdateControls = [titleInput, bodyInput, titleFontSizeSlider, bodyFontSizeSlider, textPosSlider, textWidthSlider, cardWidthInput, cardHeightInput, titleColorPicker, bodyColorPicker, titleFont, bodyFont, watermarkOpacitySlider, watermarkSizeSlider];
        liveUpdateControls.forEach(el => el.addEventListener('input', updatePreview));
        
        styleSelector.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const style = e.target.dataset.style;
                styleSelector.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                imageCanvas.className = ``;
                imageCanvas.classList.add(style);
                if (watermarkToggle.checked) imageCanvas.classList.add('watermark-active');
                
                const isDark = style === 'frame-negro';
                titleColorPicker.value = isDark ? LIGHT_TEXT_COLOR : DEFAULT_TEXT_COLOR;
                bodyColorPicker.value = isDark ? LIGHT_TEXT_COLOR : DEFAULT_TEXT_COLOR;
                titleDisplay.classList.toggle('text-on-dark', isDark);
                bodyDisplay.classList.toggle('text-on-dark', isDark);
                
                updatePreview();
            }
        });
        
        bgImageUpload.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageCanvas.style.backgroundImage = `url('${event.target.result}')`;
                    imageCanvas.style.backgroundColor = 'transparent';
                };
                reader.readAsDataURL(file);
            }
        });

        function handleFormatClick(e, displayElement) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const { style, value } = btn.dataset;
            if (style === 'textAlign') {
                btn.parentElement.querySelectorAll('.active[data-style="textAlign"]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                displayElement.style[style] = value;
            } else {
                btn.classList.toggle('active');
                displayElement.style[style] = btn.classList.contains('active') ? value : 'normal';
            }
        }
        titleFormat.addEventListener('click', (e) => handleFormatClick(e, titleDisplay));
        bodyFormat.addEventListener('click', (e) => handleFormatClick(e, bodyDisplay));

        saveBtn.addEventListener('click', () => {
            const settings = {
                title: titleInput.value, body: bodyInput.value,
                titleSize: titleFontSizeSlider.value, bodySize: bodyFontSizeSlider.value,
                titleColor: titleColorPicker.value, bodyColor: bodyColorPicker.value,
                titleFont: titleFont.value, bodyFont: bodyFont.value,
                textAlignTitle: titleDisplay.style.textAlign || 'center',
                fontWeightTitle: titleDisplay.style.fontWeight || 'normal',
                fontStyleTitle: titleDisplay.style.fontStyle || 'normal',
                textAlignBody: bodyDisplay.style.textAlign || 'center',
                fontWeightBody: bodyDisplay.style.fontWeight || 'normal',
                fontStyleBody: bodyDisplay.style.fontStyle || 'normal',
                textPos: textPosSlider.value,
                textWidth: textWidthSlider.value, // Guardar ancho
                style: styleSelector.querySelector('.active').dataset.style,
                cardW: cardWidthInput.value, cardH: cardHeightInput.value,
                paper: paperSize.value,
                watermark: watermarkToggle.checked,
                watermarkOp: watermarkOpacitySlider.value,
                watermarkSz: watermarkSizeSlider.value,
            };
            localStorage.setItem('cardDesignerSettings', JSON.stringify(settings));
            alert('¡Diseño guardado!');
        });

        loadBtn.addEventListener('click', () => {
            const settings = JSON.parse(localStorage.getItem('cardDesignerSettings'));
            if (!settings) { alert('No hay ningún diseño guardado.'); return; }
            
            titleInput.value = settings.title; bodyInput.value = settings.body;
            titleFontSizeSlider.value = settings.titleSize; bodyFontSizeSlider.value = settings.bodySize;
            titleColorPicker.value = settings.titleColor; bodyColorPicker.value = settings.bodyColor;
            titleFont.value = settings.titleFont; bodyFont.value = settings.bodyFont;
            
            function applyStyles(element, formatEl, settings, prefix) {
                element.style.textAlign = settings[`textAlign${prefix}`];
                element.style.fontWeight = settings[`fontWeight${prefix}`];
                element.style.fontStyle = settings[`fontStyle${prefix}`];
                formatEl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                const alignBtn = formatEl.querySelector(`[data-value="${settings[`textAlign${prefix}`]}"]`);
                if(alignBtn) alignBtn.classList.add('active');
                if(settings[`fontWeight${prefix}`] === 'bold') formatEl.querySelector(`[data-value="bold"]`).classList.add('active');
                if(settings[`fontStyle${prefix}`] === 'italic') formatEl.querySelector(`[data-value="italic"]`).classList.add('active');
            }
            applyStyles(titleDisplay, titleFormat, settings, 'Title');
            applyStyles(bodyDisplay, bodyFormat, settings, 'Body');
            
            textPosSlider.value = settings.textPos;
            textWidthSlider.value = settings.textWidth || 100; // Cargar ancho
            cardWidthInput.value = settings.cardW; cardHeightInput.value = settings.cardH;
            paperSize.value = settings.paper;
            watermarkToggle.checked = settings.watermark;
            watermarkOpacitySlider.value = settings.watermarkOp;
            watermarkSizeSlider.value = settings.watermarkSz;

            const styleBtn = styleSelector.querySelector(`[data-style="${settings.style}"]`);
            if (styleBtn) styleBtn.click(); else updatePreview();
        });

        resetStylesBtn.addEventListener('click', () => {
            const isDark = imageCanvas.classList.contains('frame-negro');
            titleColorPicker.value = isDark ? LIGHT_TEXT_COLOR : DEFAULT_TEXT_COLOR;
            bodyColorPicker.value = isDark ? LIGHT_TEXT_COLOR : DEFAULT_TEXT_COLOR;
            titleFontSizeSlider.value = 32; bodyFontSizeSlider.value = 22;
            titleFont.value = "'Playfair Display', serif"; bodyFont.value = "'Cormorant Garamond', serif";
            textPosSlider.value = 0;
            textWidthSlider.value = 100; // Restablecer ancho

            [titleFormat, bodyFormat].forEach(f => {
                f.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                const centerBtn = f.querySelector('[data-value="center"]');
                if (centerBtn) centerBtn.classList.add('active');
            });
            titleDisplay.style.fontWeight = 'normal'; titleDisplay.style.fontStyle = 'normal'; titleDisplay.style.textAlign = 'center';
            bodyDisplay.style.fontWeight = 'normal'; bodyDisplay.style.fontStyle = 'normal'; bodyDisplay.style.textAlign = 'center';
            updatePreview();
        });

        watermarkToggle.addEventListener('change', () => imageCanvas.classList.toggle('watermark-active', watermarkToggle.checked));
        
        productSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) { searchResults.style.display = 'none'; return; }
            const filteredProducts = productosData.filter(p => p.id.toLowerCase().includes(searchTerm) || p.title.toLowerCase().includes(searchTerm));
            searchResults.innerHTML = '';
            if (filteredProducts.length > 0) {
                filteredProducts.slice(0, 10).forEach(producto => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `<img src="${producto.imageUrl}" class="result-image"><span class="result-text">${producto.title}</span>`;
                    item.addEventListener('click', () => {
                        titleInput.value = producto.title;
                        bodyInput.value = producto.description;
                        searchResults.style.display = 'none';
                        updatePreview();
                    });
                    searchResults.appendChild(item);
                });
                searchResults.style.display = 'block';
            } else { searchResults.style.display = 'none'; }
        });
        document.addEventListener('click', (e) => { if (!productSearch.contains(e.target)) { searchResults.style.display = 'none'; } });

        async function generateOutput(format = 'print') {
            const btn = format === 'pdf' ? pdfBtn : printBtn;
            btn.textContent = 'Generando...';
            btn.disabled = true;

            const cardWidthCm = parseFloat(cardWidthInput.value) || 10;
            const cardHeightCm = parseFloat(cardHeightInput.value) || 10;
            const CM_TO_INCH = 2.54;
            const GUTTER_IN = 0.2;

            const paper = { letter: { w: 8.5, h: 11 }, a4: { w: 210 / 25.4, h: 297 / 25.4 } }[paperSize.value];
            const MARGIN_IN = 0.5;

            const printableW = paper.w - (MARGIN_IN * 2);
            const printableH = paper.h - (MARGIN_IN * 2);
            const cardW_in = (cardWidthCm / CM_TO_INCH) + GUTTER_IN;
            const cardH_in = (cardHeightCm / CM_TO_INCH) + GUTTER_IN;

            const cols = Math.floor(printableW / cardW_in);
            const rows = Math.floor(printableH / cardH_in);
            if (cols * rows === 0) {
                alert("La tarjeta es demasiado grande para el papel seleccionado.");
                btn.textContent = format === 'pdf' ? '📄 Exportar PDF' : '🖨️ Imprimir';
                btn.disabled = false; return;
            }

            const canvas = await html2canvas(imageCanvas, { scale: 3, backgroundColor: null });
            const imageDataUrl = canvas.toDataURL('image/png', 1.0);

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: paper.w > paper.h ? 'l' : 'p', unit: 'in', format: paperSize.value });
                const cardFinalW = cardW_in - GUTTER_IN;
                const cardFinalH = cardH_in - GUTTER_IN;
                const CROP_OFFSET = GUTTER_IN / 2;
                const CROP_LENGTH = CROP_OFFSET * 0.8;

                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        const x = MARGIN_IN + (j * cardW_in) + CROP_OFFSET;
                        const y = MARGIN_IN + (i * cardH_in) + CROP_OFFSET;
                        pdf.addImage(imageDataUrl, 'PNG', x, y, cardFinalW, cardFinalH);
                        
                        pdf.setDrawColor(0).setLineWidth(0.01);
                        pdf.line(x - CROP_OFFSET, y, x - CROP_LENGTH, y); 
                        pdf.line(x, y - CROP_OFFSET, x, y - CROP_LENGTH); 
                        pdf.line(x + cardFinalW + CROP_OFFSET, y, x + cardFinalW + CROP_LENGTH, y);
                        pdf.line(x + cardFinalW, y - CROP_OFFSET, x + cardFinalW, y - CROP_LENGTH);
                        pdf.line(x - CROP_OFFSET, y + cardFinalH, x - CROP_LENGTH, y + cardFinalH);
                        pdf.line(x, y + cardFinalH + CROP_OFFSET, x, y + cardFinalH + CROP_LENGTH);
                        pdf.line(x + cardFinalW + CROP_OFFSET, y + cardFinalH, x + cardFinalW + CROP_LENGTH, y + cardFinalH);
                        pdf.line(x + cardFinalW, y + cardFinalH + CROP_OFFSET, x + cardFinalW, y + cardFinalH + CROP_LENGTH);
                    }
                }
                pdf.save('tarjetas.pdf');
            } else {
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = '';
                printArea.style.width = `${paper.w}in`;
                printArea.style.height = `${paper.h}in`;
                printArea.style.padding = `${MARGIN_IN}in`;
                
                for(let i=0; i < (rows*cols); i++) {
                     printArea.innerHTML += `
                        <div class="print-card-wrapper" style="width: ${cardW_in - GUTTER_IN}in; height: ${cardH_in - GUTTER_IN}in; margin: ${GUTTER_IN/2}in;">
                            <img src="${imageDataUrl}" style="width:100%; height:100%;" />
                        </div>`;
                }
                window.print();
            }
            
            btn.textContent = format === 'pdf' ? '📄 Exportar PDF' : '🖨️ Imprimir';
            btn.disabled = false;
        }

        downloadBtn.addEventListener('click', () => {
            html2canvas(imageCanvas, { scale: 4, backgroundColor: null }).then(c => {
                const link = document.createElement('a');
                link.download = `tarjeta-${titleInput.value.replace(/\s/g, "_") || 'diseño'}.png`;
                link.href = c.toDataURL('image/png', 1.0);
                link.click();
            });
        });
        pdfBtn.addEventListener('click', () => generateOutput('pdf'));
        printBtn.addEventListener('click', () => generateOutput('print'));
        
        document.addEventListener('DOMContentLoaded', () => {
            fetch('index.html')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar index.html.');
                    return response.text();
                })
                .then(htmlString => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, 'text/html');
                    doc.querySelectorAll('.producto').forEach(prodElement => {
                        const titleElement = prodElement.querySelector('h3.titulo-producto');
                        const imageElement = prodElement.querySelector('.carousel-images img');
                        if (titleElement && imageElement) {
                            const title = titleElement.textContent.trim();
                            let descriptionParts = [];
                            let currentElement = titleElement.nextElementSibling;
                            while (currentElement) {
                                if (currentElement.tagName === 'P' && !currentElement.classList.contains('precio')) {
                                    descriptionParts.push(currentElement.textContent.trim());
                                }
                                if (currentElement.classList.contains('precio') || currentElement.tagName === 'DIV') break;
                                currentElement = currentElement.nextElementSibling;
                            }
                            const description = descriptionParts.join('\n\n');
                            const idMatch = title.match(/B-\d+|BA-\d+/);
                            const id = idMatch ? idMatch[0] : title.split(' ').pop();
                            const imageUrl = imageElement.getAttribute('src').replace(/\\/g, '/');
                            if(description) productosData.push({ id, title, description, imageUrl });
                        }
                    });
                    productSearch.placeholder = `Busca entre ${productosData.length} productos...`;
                })
                .catch(error => {
                    console.error('Error al cargar productos:', error);
                    productSearch.placeholder = "Error al cargar productos.";
                })
                .finally(updatePreview);
        });
    })();
    </script>
</body>
</html>
