<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio de Diseño de Tarjetas v2.0</title>
    
    <!-- FUENTES DE GOOGLE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Dancing+Script:wght@700&family=Lato:ital,wght@0,400;1,400&family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <!-- LIBRERÍAS EXTERNAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- ICONOS (FONT AWESOME) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --dark-bg: #1A202C;
            --dark-panel: #2D3748;
            --dark-text: #E2E8F0;
            --dark-text-secondary: #A0AEC0;
            --accent-color: #D69E2E;
            --accent-hover: #ECC94B;
            --light-bg: #F7FAFC;
            --border-color: #4A5568;
        }

        /* --- ESTRUCTURA GENERAL --- */
        body { font-family: 'Montserrat', sans-serif; background-color: var(--light-bg); margin: 0; padding: 1rem; color: var(--dark-text); display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .studio-container { display: grid; grid-template-columns: 400px 1fr; gap: 2rem; width: 100%; max-width: 1400px; height: 90vh; }
        
        /* --- PANEL DE CONTROLES (IZQUIERDA) --- */
        .controls-panel { background-color: var(--dark-bg); padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-y: auto; }
        .controls-panel h1 { font-family: 'Playfair Display', serif; color: white; margin-top: 0; font-size: 2.5rem; text-align: center; }
        .controls-panel h2 { color: var(--accent-color); font-size: 1.2rem; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .control-group { margin-bottom: 1.5rem; }
        .control-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.8rem; color: var(--dark-text-secondary); text-transform: uppercase; }

        /* Estilos de Inputs para tema oscuro */
        input[type="text"], input[type="number"], textarea, select {
            width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color);
            background-color: var(--dark-panel); color: var(--dark-text); font-size: 1rem;
            box-sizing: border-box; transition: all 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(214, 158, 46, 0.3);
        }
        textarea { height: 80px; resize: vertical; }

        /* Selectores de estilo rediseñados */
        .style-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; }
        .style-selector button {
            background: var(--dark-panel); color: var(--dark-text-secondary); border: 1px solid var(--border-color);
            padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;
        }
        .style-selector button.active { background-color: var(--accent-color); color: var(--dark-bg); font-weight: bold; border-color: var(--accent-color); }

        /* Controles de tipografía */
        .typography-card { background-color: var(--dark-panel); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .format-controls { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center; }
        .format-buttons { display: flex; gap: 0.5rem; background-color: var(--dark-bg); padding: 5px; border-radius: 8px; }
        .format-buttons button { background: transparent; border: none; color: var(--dark-text-secondary); width: 35px; height: 35px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 1rem; }
        .format-buttons button:hover { background-color: #4A5568; }
        .format-buttons button.active { background-color: var(--accent-color); color: var(--dark-bg); }
        input[type="color"] { width: 45px; height: 45px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; padding: 3px; background-color: var(--dark-panel); }

        /* Sliders Rediseñados */
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--dark-panel); border-radius: 5px; outline: none; margin-top: 0.5rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--accent-color); border-radius: 50%; cursor: pointer; transition: background 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { background: var(--accent-hover); }

        /* Botones de Acción */
        .action-buttons button, .utility-buttons button {
            color: var(--dark-bg); background: var(--accent-color); border: none; padding: 1rem;
            border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.75rem;
        }
        .action-buttons button:hover, .utility-buttons button:hover { background: var(--accent-hover); }
        .utility-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
        #pdfBtn { background-color: #C53030; color: white; } #pdfBtn:hover { background-color: #E53E3E; }
        #resetStylesBtn { background-color: #718096; color: white; } #resetStylesBtn:hover { background-color: #A0AEC0; }
        
        /* --- PANEL DE PREVISUALIZACIÓN (DERECHA) --- */
        .preview-area { background-color: var(--dark-bg); border-radius: 15px; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .preview-area h3 { color: var(--dark-text-secondary); text-transform: uppercase; letter-spacing: 1px; margin: 0 0 2rem 0; }
        #image-canvas { position: relative; overflow: hidden; background-size: cover; background-position: center; transition: all 0.4s ease-in-out; }
        #text-container { position: absolute; top: 50%; left: 50%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-sizing: border-box; z-index: 2; transition: all 0.3s ease; }
        #title-display, #body-display { transition: all 0.3s ease; }
        #title-display { margin-bottom: 1rem; line-height: 1.2; font-family: 'Playfair Display', serif; }
        #body-display { line-height: 1.6; white-space: pre-wrap; margin: 0 auto; font-family: 'Lato', sans-serif; }
        #watermark-logo { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('logoblanco.jpg'); background-position: center; background-repeat: no-repeat; z-index: 1; transition: all 0.5s ease; }
        
        /* Estilos de los marcos */
        .frame-clasico { background-color: #F9F5EF; border: 1px solid #D1BBA3; padding: 5%; }
        .frame-clasico::before { content: ''; position: absolute; top: 25px; left: 25px; right: 25px; bottom: 25px; border: 2px solid #BFA17A; z-index: 0; }
        .frame-artistico { background-color: #F9F5EF; border: 1px solid #D1BBA3; padding: 5%; }
        .frame-artistico::before, .frame-artistico::after { content: ''; position: absolute; width: 60px; height: 60px; border-color: #BFA17A; border-style: solid; z-index: 0; }
        .frame-artistico::before { top: 30px; left: 30px; border-width: 3px 0 0 3px; }
        .frame-artistico::after { bottom: 30px; right: 30px; border-width: 0 3px 3px 0; }
        .frame-negro { background-color: white; border: none; }
        .frame-negro::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('images/marco.png'); background-size: cover; }
        .frame-negro #title-display, .frame-negro #body-display { color: #FFFFFF; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .frame-floral-dorado { background-color: white; border: 5px solid; border-image-slice: 1; border-image-source: url('images/glitter-border.png'); padding: 5%; }
        .frame-floral-dorado::before, .frame-floral-dorado::after { content: ''; position: absolute; width: 25%; height: 25%; background-size: contain; background-repeat: no-repeat; z-index: 3; }
        .frame-floral-dorado::before { top: 15px; left: 15px; background-image: url('images/floral-corner-top-left.png'); }
        .frame-floral-dorado::after { bottom: 15px; right: 15px; background-image: url('images/floral-corner-bottom-right.png'); }

        #print-area { display: none; }
    </style>
</head>
<body>
    <div class="studio-container">
        <div class="controls-panel">
            <h1>Estudio de Diseño</h1>
            <div class="utility-buttons">
                 <button id="saveBtn"><i class="fas fa-save"></i> Guardar</button>
                 <button id="loadBtn"><i class="fas fa-folder-open"></i> Cargar</button>
            </div>

            <section>
                <h2>1. Contenido y Plantillas</h2>
                <div class="control-group">
                    <label for="product-search">Buscar Producto</label>
                    <input type="text" id="product-search" placeholder="Cargando...">
                    <div id="search-results"></div>
                </div>
                 <div class="control-group">
                    <label>Estilo de Fondo</label>
                    <div class="style-selector" id="style-select">
                        <button class="active" data-style="frame-clasico">Clásico</button>
                        <button data-style="frame-artistico">Artístico</button>
                        <button data-style="frame-negro">Negro</button>
                        <button data-style="frame-floral-dorado">Floral</button>
                    </div>
                </div>
                <div class="control-group">
                     <label for="bgImageUpload">Fondo Personalizado</label>
                     <input type="file" id="bgImageUpload" accept="image/*" style="padding: 0.5rem; font-size: 0.9rem;">
                </div>
                <div class="control-group">
                    <label for="titleInput">Título</label>
                    <input type="text" id="titleInput" placeholder="Un Regalo Especial">
                </div>
                <div class="control-group">
                    <label for="bodyInput">Mensaje</label>
                    <textarea id="bodyInput">Este producto fue preparado con especial cuidado para ti.</textarea>
                </div>
            </section>

            <section>
                <h2>2. Tipografía y Estilo de Texto</h2>
                <div class="typography-card">
                    <label>Título</label>
                    <select id="titleFont">
                        <option value="'Playfair Display', serif">Playfair Display</option>
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                        <option value="'Lato', sans-serif">Lato</option>
                        <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                        <option value="'Dancing Script', cursive">Dancing Script</option>
                    </select>
                    <div class="format-controls" style="margin-top:1rem;">
                        <div class="format-buttons" id="title-format">
                            <button data-style="textAlign" data-value="left" title="Alinear Izquierda"><i class="fas fa-align-left"></i></button>
                            <button data-style="textAlign" data-value="center" class="active" title="Centrar"><i class="fas fa-align-center"></i></button>
                            <button data-style="textAlign" data-value="right" title="Alinear Derecha"><i class="fas fa-align-right"></i></button>
                            <button data-style="fontWeight" data-value="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                            <button data-style="fontStyle" data-value="italic" title="Itálica"><i class="fas fa-italic"></i></button>
                        </div>
                        <input type="color" id="titleColor" value="#4B4B4B">
                    </div>
                    <label style="margin-top:1rem;">Tamaño</label>
                    <input type="range" id="titleFontSizeSlider" min="20" max="100" value="40">
                </div>

                <div class="typography-card">
                    <label>Mensaje</label>
                    <select id="bodyFont">
                         <option value="'Lato', sans-serif">Lato</option>
                         <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                         <option value="'Montserrat', sans-serif">Montserrat</option>
                         <option value="'Playfair Display', serif">Playfair Display</option>
                         <option value="'Dancing Script', cursive">Dancing Script</option>
                    </select>
                    <div class="format-controls" style="margin-top:1rem;">
                         <div class="format-buttons" id="body-format">
                            <button data-style="textAlign" data-value="left" title="Alinear Izquierda"><i class="fas fa-align-left"></i></button>
                            <button data-style="textAlign" data-value="center" class="active" title="Centrar"><i class="fas fa-align-center"></i></button>
                            <button data-style="textAlign" data-value="right" title="Alinear Derecha"><i class="fas fa-align-right"></i></button>
                            <button data-style="fontWeight" data-value="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                            <button data-style="fontStyle" data-value="italic" title="Itálica"><i class="fas fa-italic"></i></button>
                         </div>
                         <input type="color" id="bodyColor" value="#4B4B4B">
                    </div>
                    <label style="margin-top:1rem;">Tamaño</label>
                    <input type="range" id="bodyFontSizeSlider" min="14" max="60" value="22">
                </div>

                <div class="control-group">
                    <label>Ajustes de Maquetación</label>
                    <label for="textPosSlider">Posición Vertical</label>
                    <input type="range" id="textPosSlider" min="-50" max="50" value="0">
                    <label for="textWidthSlider" style="margin-top: 1rem;">Ancho del Texto</label>
                    <input type="range" id="textWidthSlider" min="80" max="120" value="100">
                </div>
                <button id="resetStylesBtn" style="width:100%;"><i class="fas fa-undo"></i> Restablecer Estilos</button>
            </section>
            
            <section>
                <h2>3. Lienzo y Exportación</h2>
                <div class="control-group">
                    <label>Tamaño de Tarjeta (cm)</label>
                    <div class="size-inputs">
                        <input type="number" id="cardWidth" value="10" min="1">
                        <input type="number" id="cardHeight" value="10" min="1">
                    </div>
                </div>
                 <div class="control-group">
                    <label for="paperSize">Tamaño de Papel</label>
                    <select id="paperSize">
                        <option value="letter">Carta (8.5 x 11 in)</option>
                        <option value="a4">A4 (210 x 297 mm)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label><input type="checkbox" id="watermarkToggle" checked> Añadir logo</label>
                    <label for="watermarkOpacitySlider">Opacidad del Logo</label>
                    <input type="range" id="watermarkOpacitySlider" min="0" max="100" value="15">
                    <label for="watermarkSizeSlider">Tamaño del Logo</label>
                    <input type="range" id="watermarkSizeSlider" min="20" max="100" value="60">
                </div>
                <div class="action-buttons" style="flex-direction: column;">
                    <button id="downloadBtn"><i class="fas fa-file-image"></i> Descargar PNG</button>
                    <button id="pdfBtn"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                    <button id="printBtn"><i class="fas fa-print"></i> Imprimir</button>
                </div>
            </section>
        </div>
        <div class="preview-area">
            <h3>Previsualización en Vivo</h3>
            <div id="image-canvas" class="frame-clasico watermark-active">
                <div id="watermark-logo"></div>
                <div id="text-container">
                    <div id="title-display"></div>
                    <div id="body-display"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="print-area"></div>

    <script>
    (() => {
        // --- CONSTANTES DE ELEMENTOS DEL DOM ---
        const imageCanvas = document.getElementById('image-canvas');
        const textContainer = document.getElementById('text-container');
        const titleDisplay = document.getElementById('title-display');
        const bodyDisplay = document.getElementById('body-display');
        const watermarkLogo = document.getElementById('watermark-logo');
        const productSearch = document.getElementById('product-search');
        const searchResults = document.getElementById('search-results');
        const styleSelector = document.getElementById('style-select');
        const bgImageUpload = document.getElementById('bgImageUpload');
        const titleInput = document.getElementById('titleInput');
        const bodyInput = document.getElementById('bodyInput');
        const titleFont = document.getElementById('titleFont');
        const bodyFont = document.getElementById('bodyFont');
        const titleFormat = document.getElementById('title-format');
        const bodyFormat = document.getElementById('body-format');
        const titleColorPicker = document.getElementById('titleColor');
        const bodyColorPicker = document.getElementById('bodyColor');
        const titleFontSizeSlider = document.getElementById('titleFontSizeSlider');
        const bodyFontSizeSlider = document.getElementById('bodyFontSizeSlider');
        const textPosSlider = document.getElementById('textPosSlider');
        const textWidthSlider = document.getElementById('textWidthSlider');
        const watermarkToggle = document.getElementById('watermarkToggle');
        const watermarkOpacitySlider = document.getElementById('watermarkOpacitySlider');
        const watermarkSizeSlider = document.getElementById('watermarkSizeSlider');
        const cardWidthInput = document.getElementById('cardWidth');
        const cardHeightInput = document.getElementById('cardHeight');
        const paperSize = document.getElementById('paperSize');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const resetStylesBtn = document.getElementById('resetStylesBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const pdfBtn = document.getElementById('pdfBtn');
        const printBtn = document.getElementById('printBtn');

        let productosData = [];
        const DEFAULT_TEXT_COLOR = '#4B4B4B';
        const LIGHT_TEXT_COLOR = '#FFFFFF';

        function updatePreview() {
            const fullTitle = titleInput.value;
            const words = fullTitle.trim().split(/\s+/);

            if (words.length > 2) { 
                const lastWord = words.pop();
                const secondLastWord = words.pop();
                titleDisplay.innerHTML = `${words.join(' ')}<br>${secondLastWord} ${lastWord}`;
            } else {
                titleDisplay.innerHTML = fullTitle.replace(/\n/g, "<br>");
            }
            bodyDisplay.innerText = bodyInput.value;

            Object.assign(titleDisplay.style, { fontSize: `${titleFontSizeSlider.value}px`, color: titleColorPicker.value, fontFamily: titleFont.value });
            Object.assign(bodyDisplay.style, { fontSize: `${bodyFontSizeSlider.value}px`, color: bodyColorPicker.value, fontFamily: bodyFont.value });
            
            const verticalOffset = textPosSlider.value;
            textContainer.style.width = `${textWidthSlider.value}%`;
            textContainer.style.transform = `translate(-50%, calc(-50% + ${verticalOffset}%))`;
            
            watermarkLogo.style.opacity = watermarkOpacitySlider.value / 100;
            watermarkLogo.style.backgroundSize = `${watermarkSizeSlider.value}%`;
            
            updatePreviewSize();
        }

        function updatePreviewSize() {
            const aspect = (parseFloat(cardWidthInput.value) || 10) / (parseFloat(cardHeightInput.value) || 10);
            const maxWidth = Math.min(document.querySelector('.preview-area').clientWidth - 64, 550);
            imageCanvas.style.width = `${maxWidth}px`;
            imageCanvas.style.height = `${maxWidth / aspect}px`;
        }
        
        const liveUpdateControls = [titleInput, bodyInput, titleFontSizeSlider, bodyFontSizeSlider, textPosSlider, textWidthSlider, cardWidthInput, cardHeightInput, titleColorPicker, bodyColorPicker, titleFont, bodyFont, watermarkOpacitySlider, watermarkSizeSlider];
        liveUpdateControls.forEach(el => el.addEventListener('input', updatePreview));
        
        styleSelector.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const style = e.target.dataset.style;
                styleSelector.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                imageCanvas.className = ``;
                imageCanvas.classList.add(style);
                if (watermarkToggle.checked) imageCanvas.classList.add('watermark-active');
                
                if (style === 'frame-negro') {
                    titleColorPicker.value = LIGHT_TEXT_COLOR;
                    bodyColorPicker.value = LIGHT_TEXT_COLOR;
                } else {
                    titleColorPicker.value = titleDisplay.style.color || DEFAULT_TEXT_COLOR;
                    bodyColorPicker.value = bodyDisplay.style.color || DEFAULT_TEXT_COLOR;
                }
                updatePreview();
            }
        });
        
        bgImageUpload.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imageCanvas.style.backgroundImage = `url('${event.target.result}')`;
                };
                reader.readAsDataURL(file);
            }
        });

        function handleFormatClick(e, displayElement) {
            const btn = e.target.closest('button');
            if (!btn) return;
            const { style, value } = btn.dataset;
            if (style === 'textAlign') {
                btn.parentElement.querySelectorAll('.active[data-style="textAlign"]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                displayElement.style[style] = value;
            } else {
                btn.classList.toggle('active');
                displayElement.style[style] = btn.classList.contains('active') ? value : 'normal';
            }
        }
        titleFormat.addEventListener('click', (e) => handleFormatClick(e, titleDisplay));
        bodyFormat.addEventListener('click', (e) => handleFormatClick(e, bodyDisplay));

        saveBtn.addEventListener('click', () => {
            const settings = {
                title: titleInput.value, body: bodyInput.value,
                titleSize: titleFontSizeSlider.value, bodySize: bodyFontSizeSlider.value,
                titleColor: titleColorPicker.value, bodyColor: bodyColorPicker.value,
                titleFont: titleFont.value, bodyFont: bodyFont.value,
                textAlignTitle: titleDisplay.style.textAlign || 'center',
                fontWeightTitle: titleDisplay.style.fontWeight || 'normal',
                fontStyleTitle: titleDisplay.style.fontStyle || 'normal',
                textAlignBody: bodyDisplay.style.textAlign || 'center',
                fontWeightBody: bodyDisplay.style.fontWeight || 'normal',
                fontStyleBody: bodyDisplay.style.fontStyle || 'normal',
                textPos: textPosSlider.value,
                textWidth: textWidthSlider.value,
                style: styleSelector.querySelector('.active').dataset.style,
                cardW: cardWidthInput.value, cardH: cardHeightInput.value,
                paper: paperSize.value,
                watermark: watermarkToggle.checked,
                watermarkOp: watermarkOpacitySlider.value,
                watermarkSz: watermarkSizeSlider.value,
            };
            localStorage.setItem('cardDesignerSettingsV2', JSON.stringify(settings));
            alert('¡Diseño guardado!');
        });

        loadBtn.addEventListener('click', () => {
            const settings = JSON.parse(localStorage.getItem('cardDesignerSettingsV2'));
            if (!settings) { alert('No hay ningún diseño guardado.'); return; }
            
            titleInput.value = settings.title; bodyInput.value = settings.body;
            titleFontSizeSlider.value = settings.titleSize; bodyFontSizeSlider.value = settings.bodySize;
            titleColorPicker.value = settings.titleColor; bodyColorPicker.value = settings.bodyColor;
            titleFont.value = settings.titleFont; bodyFont.value = settings.bodyFont;
            
            function applyStyles(element, formatEl, settings, prefix) {
                element.style.textAlign = settings[`textAlign${prefix}`];
                element.style.fontWeight = settings[`fontWeight${prefix}`];
                element.style.fontStyle = settings[`fontStyle${prefix}`];
                formatEl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                const alignBtn = formatEl.querySelector(`[data-value="${settings[`textAlign${prefix}`]}"]`);
                if(alignBtn) alignBtn.classList.add('active');
                if(settings[`fontWeight${prefix}`] === 'bold') formatEl.querySelector(`[data-value="bold"]`).classList.add('active');
                if(settings[`fontStyle${prefix}`] === 'italic') formatEl.querySelector(`[data-value="italic"]`).classList.add('active');
            }
            applyStyles(titleDisplay, titleFormat, settings, 'Title');
            applyStyles(bodyDisplay, bodyFormat, settings, 'Body');
            
            textPosSlider.value = settings.textPos;
            textWidthSlider.value = settings.textWidth || 100;
            cardWidthInput.value = settings.cardW; cardHeightInput.value = settings.cardH;
            paperSize.value = settings.paper;
            watermarkToggle.checked = settings.watermark;
            watermarkOpacitySlider.value = settings.watermarkOp;
            watermarkSizeSlider.value = settings.watermarkSz;

            const styleBtn = styleSelector.querySelector(`[data-style="${settings.style}"]`);
            if (styleBtn) styleBtn.click(); else updatePreview();
        });

        resetStylesBtn.addEventListener('click', () => {
            const isDark = imageCanvas.classList.contains('frame-negro');
            titleColorPicker.value = isDark ? LIGHT_TEXT_COLOR : DEFAULT_TEXT_COLOR;
            bodyColorPicker.value = isDark ? LIGHT_TEXT_COLOR : DEFAULT_TEXT_COLOR;
            titleFontSizeSlider.value = 40; bodyFontSizeSlider.value = 22;
            titleFont.value = "'Playfair Display', serif"; bodyFont.value = "'Lato', sans-serif";
            textPosSlider.value = 0;
            textWidthSlider.value = 100;

            [titleFormat, bodyFormat].forEach(f => {
                f.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                const centerBtn = f.querySelector('[data-value="center"]');
                if (centerBtn) centerBtn.classList.add('active');
            });
            titleDisplay.style.fontWeight = 'normal'; titleDisplay.style.fontStyle = 'normal'; titleDisplay.style.textAlign = 'center';
            bodyDisplay.style.fontWeight = 'normal'; bodyDisplay.style.fontStyle = 'normal'; bodyDisplay.style.textAlign = 'center';
            updatePreview();
        });

        watermarkToggle.addEventListener('change', () => imageCanvas.classList.toggle('watermark-active', watermarkToggle.checked));
        
        productSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) { searchResults.style.display = 'none'; return; }
            const filteredProducts = productosData.filter(p => p.id.toLowerCase().includes(searchTerm) || p.title.toLowerCase().includes(searchTerm));
            searchResults.innerHTML = '';
            if (filteredProducts.length > 0) {
                filteredProducts.slice(0, 10).forEach(producto => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `<img src="${producto.imageUrl}" class="result-image"><span class="result-text">${producto.title}</span>`;
                    item.addEventListener('click', () => {
                        titleInput.value = producto.title;
                        bodyInput.value = producto.description;
                        searchResults.style.display = 'none';
                        updatePreview();
                    });
                    searchResults.appendChild(item);
                });
                searchResults.style.display = 'block';
            } else { searchResults.style.display = 'none'; }
        });
        document.addEventListener('click', (e) => { if (!productSearch.contains(e.target)) { searchResults.style.display = 'none'; } });

        async function generateOutput(format = 'print') {
            const btn = format === 'pdf' ? pdfBtn : printBtn;
            btn.disabled = true;

            const cardWidthCm = parseFloat(cardWidthInput.value) || 10;
            const cardHeightCm = parseFloat(cardHeightInput.value) || 10;
            const CM_TO_INCH = 2.54;
            const GUTTER_IN = 0.2;

            const paper = { letter: { w: 8.5, h: 11 }, a4: { w: 210 / 25.4, h: 297 / 25.4 } }[paperSize.value];
            const MARGIN_IN = 0.5;

            const printableW = paper.w - (MARGIN_IN * 2);
            const printableH = paper.h - (MARGIN_IN * 2);
            const cardW_in = (cardWidthCm / CM_TO_INCH) + GUTTER_IN;
            const cardH_in = (cardHeightCm / CM_TO_INCH) + GUTTER_IN;

            const cols = Math.floor(printableW / cardW_in);
            const rows = Math.floor(printableH / cardH_in);
            if (cols * rows === 0) {
                alert("La tarjeta es demasiado grande para el papel seleccionado.");
                btn.disabled = false; return;
            }

            const canvas = await html2canvas(imageCanvas, { scale: 3, backgroundColor: null });
            const imageDataUrl = canvas.toDataURL('image/png', 1.0);

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: paper.w > paper.h ? 'l' : 'p', unit: 'in', format: paperSize.value });
                const cardFinalW = cardW_in - GUTTER_IN;
                const cardFinalH = cardH_in - GUTTER_IN;
                const CROP_OFFSET = GUTTER_IN / 2;
                const CROP_LENGTH = CROP_OFFSET * 0.8;

                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        const x = MARGIN_IN + (j * cardW_in) + CROP_OFFSET;
                        const y = MARGIN_IN + (i * cardH_in) + CROP_OFFSET;
                        pdf.addImage(imageDataUrl, 'PNG', x, y, cardFinalW, cardFinalH);
                        
                        pdf.setDrawColor(0).setLineWidth(0.01);
                        pdf.line(x - CROP_OFFSET, y, x - CROP_LENGTH, y); 
                        pdf.line(x, y - CROP_OFFSET, x, y - CROP_LENGTH); 
                        pdf.line(x + cardFinalW + CROP_OFFSET, y, x + cardFinalW + CROP_LENGTH, y);
                        pdf.line(x + cardFinalW, y - CROP_OFFSET, x + cardFinalW, y - CROP_LENGTH);
                        pdf.line(x - CROP_OFFSET, y + cardFinalH, x - CROP_LENGTH, y + cardFinalH);
                        pdf.line(x, y + cardFinalH + CROP_OFFSET, x, y + cardFinalH + CROP_LENGTH);
                        pdf.line(x + cardFinalW + CROP_OFFSET, y + cardFinalH, x + cardFinalW + CROP_LENGTH, y + cardFinalH);
                        pdf.line(x + cardFinalW, y + cardFinalH + CROP_OFFSET, x + cardFinalW, y + cardFinalH + CROP_LENGTH);
                    }
                }
                pdf.save('tarjetas.pdf');
            } else {
                window.print();
            }
            
            btn.disabled = false;
        }

        downloadBtn.addEventListener('click', () => {
            html2canvas(imageCanvas, { scale: 4, backgroundColor: null }).then(c => {
                const link = document.createElement('a');
                link.download = `tarjeta-${titleInput.value.replace(/\s/g, "_") || 'diseño'}.png`;
                link.href = c.toDataURL('image/png', 1.0);
                link.click();
            });
        });
        pdfBtn.addEventListener('click', () => generateOutput('pdf'));
        printBtn.addEventListener('click', () => generateOutput('print'));
        
        document.addEventListener('DOMContentLoaded', () => {
            fetch('index.html')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar index.html.');
                    return response.text();
                })
                .then(htmlString => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, 'text/html');
                    doc.querySelectorAll('.producto').forEach(prodElement => {
                        const titleElement = prodElement.querySelector('h3.titulo-producto');
                        const imageElement = prodElement.querySelector('.carousel-images img');
                        if (titleElement && imageElement) {
                            const title = titleElement.textContent.trim();
                            let descriptionParts = [];
                            let currentElement = titleElement.nextElementSibling;
                            while (currentElement) {
                                if (currentElement.tagName === 'P' && !currentElement.classList.contains('precio')) {
                                    descriptionParts.push(currentElement.textContent.trim());
                                }
                                if (currentElement.classList.contains('precio') || currentElement.tagName === 'DIV') break;
                                currentElement = currentElement.nextElementSibling;
                            }
                            const description = descriptionParts.join('\n\n');
                            const idMatch = title.match(/B-\d+|BA-\d+/);
                            const id = idMatch ? idMatch[0] : title.split(' ').pop();
                            const imageUrl = imageElement.getAttribute('src').replace(/\\/g, '/');
                            if(description) productosData.push({ id, title, description, imageUrl });
                        }
                    });
                    productSearch.placeholder = `Busca entre ${productosData.length} productos...`;
                })
                .catch(error => {
                    console.error('Error al cargar productos:', error);
                    productSearch.placeholder = "Error al cargar productos.";
                })
                .finally(updatePreview);
        });
    })();
    </script>
</body>
</html>
