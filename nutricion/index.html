<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Alimentación Inteligente v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #f0f9ff; /* sky-50 fallback */
        }
        .card-element { /* Clase unificada para tarjetas */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Sombra suave y moderna */
            border-radius: 0.75rem; /* rounded-xl */
            background-color: white;
        }
        .card-element:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1), 0 6px 6px rgba(0, 0, 0, 0.07);
        }
        input[type="checkbox"] {
            accent-color: #0ea5e9; /* sky-500 */
            border-radius: 0.25rem;
            border: 1px solid #7dd3fc; /* sky-300 */
            height: 1.125rem; 
            width: 1.125rem; 
        }
        .section-header {
            border-bottom-width: 2px;
            border-color: #38bdf8; /* sky-400 */
            padding-bottom: 0.75rem;
            margin-bottom: 2rem;
        }
        .generated-meal-card h4, .shopping-list-card h5 {
            font-weight: 600; 
            color: #0369a1; /* sky-700 */
            margin-bottom: 0.5rem;
        }
        .generated-meal-card ul, #generatedShoppingListContainer ul {
            list-style-type: none; 
            padding-left: 0;
        }
        .generated-meal-card ul li {
            margin-bottom: 0.375rem; 
            padding-left: 1.35rem; 
            position: relative;
            font-size: 0.875rem; 
            color: #4b5563; /* gray-600 */
        }
        .generated-meal-card ul li::before {
            content: '›'; /* Icono de flecha sutil */
            position: absolute;
            left: 0.25rem;
            color: #0ea5e9; /* sky-500 */
            font-weight: 700;
            font-size: 1rem;
            line-height: 1.1;
        }
        #generatedShoppingListContainer ul li {
            padding: 0.3rem 0;
            font-size: 0.9rem;
            color: #374151; /* gray-700 */
            border-bottom: 1px dashed #e0f2fe; /* sky-100 */
        }
        #generatedShoppingListContainer ul li:last-child {
            border-bottom: none;
        }

        .custom-input {
            border: 1px solid #bae6fd; /* sky-200 */
            border-radius: 0.5rem; 
            padding: 0.75rem 1rem; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            color: #374151; /* gray-700 */
        }
        .custom-input:focus {
            border-color: #0ea5e9; /* sky-500 */
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); 
            outline: none;
        }
        .custom-btn {
            padding: 0.8rem 1.6rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .custom-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        .custom-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .custom-btn-sky { /* Botón primario */
            background-color: #0ea5e9; /* sky-500 */
            color: white;
        }
        .custom-btn-sky:hover:not(:disabled) {
            background-color: #0284c7; /* sky-600 */
        }
        .custom-btn-teal { /* Botón secundario */
            background-color: #14b8a6; /* teal-500 */
            color: white;
        }
        .custom-btn-teal:hover:not(:disabled) {
            background-color: #0d9488; /* teal-600 */
        }
         .custom-btn-slate { /* Botón para acciones como cargar */
            background-color: #475569; /* slate-600 */
            color: white;
        }
        .custom-btn-slate:hover:not(:disabled) {
            background-color: #334155; /* slate-700 */
        }
        
        /* Responsive shopping list (base) */
        #lista-compras-base .grid {
            grid-template-columns: 1fr;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            #lista-compras-base .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            #lista-compras-base .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-cyan-50 to-teal-50 text-gray-700 min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-6xl">

        <header class="text-center mb-12 md:mb-16">
            <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-sky-700 mb-4">Planificador Nutricional Inteligente</h1>
            <p class="text-lg sm:text-xl text-sky-600">Menús semanales personalizados y listas de compras</p>
            <p class="mt-4 text-gray-600 max-w-3xl mx-auto text-sm sm:text-base">
                Organiza tu alimentación de forma sencilla y saludable. Genera menús basados en tus guías nutricionales y obtén listas de compras automáticas.
            </p>
        </header>

        <section id="semana1" class="mb-12">
            <h2 class="text-3xl md:text-4xl font-semibold text-sky-700 section-header">Semana 1 (Ejemplo Fijo)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="card-element p-6"> 
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Lunes</h3>
                    <div class="space-y-4 text-sm"> 
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">Arepa mediana + 1 huevo + 1 cdt. mantequilla + 1 vaso leche semidescremada + 1 mandarina grande.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">12 fresas + 1 cda. almendras.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Pechuga de pollo plancha + 6 cdas. arroz + ½ pocillo lentejas + ensalada tomate y lechuga + 1 cda. aceite oliva + 1 rebanada piña.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 yogur dietético + 1 manzana pequeña.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Filete pescado horno + ½ pocillo pasta + espinacas vapor + 1 cdt. aceite vegetal + 1 durazno mediano.</p></div>
                    </div>
                </div>
                <div class="card-element p-6">
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Martes</h3>
                    <div class="space-y-4 text-sm">
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">2 tostadas integrales + 2 tajadas queso + 1 cdt. mermelada + 1 taza té + 1 guayaba mediana.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">1 pera mediana + 1 cda. maní.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Carne magra res + 1 papa cocida + ½ pocillo frijoles + ensalada zanahoria y pepino + 1 cda. aceite + 2 maracuyás.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 vaso kumis dietético + 12 uvas.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Atún en agua + 2 arepas pequeñas + brócoli vapor + 1 cdt. mayonesa + 1 tajada papaya.</p></div>
                    </div>
                </div>
                 <div class="card-element p-6">
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Miércoles</h3>
                    <div class="space-y-4 text-sm">
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">Avena (3 cdas.) + 1 cda. miel + 1 vaso leche semidescremada + 1 banano pequeño.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">1 mango pequeño + 1 cda. nueces.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Muslo pollo s/piel + ½ pocillo quinua + ensalada aguacate (¼) y tomate + 1 cda. aceite + 1 naranja mediana.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 yogur + 7 uvas chilenas.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Tortilla espinacas (1 huevo) + 1 tajada pan integral + 1 cdt. aceite oliva + 1 manzana pequeña.</p></div>
                    </div>
                </div>
                <div class="card-element p-6">
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Jueves</h3>
                    <div class="space-y-4 text-sm">
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">1 arepa maíz + 1 tajada jamón + 1 cdt. margarina + 1 taza café + 2 ciruelas pequeñas.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">1 durazno mediano + 1 cda. ajonjolí.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Filete cerdo magro + ½ pocillo arroz integral + ensalada remolacha + 1 cda. aceite + 1 tajada sandía.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 vaso leche + 12 uchuvas.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Sopa verduras c/pollo + 1 arepa pequeña + 1 cdt. crema de leche + 1 pera.</p></div>
                    </div>
                </div>
                <div class="card-element p-6">
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Viernes</h3>
                    <div class="space-y-4 text-sm">
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">1 pan integral + 1 huevo revuelto + 1 cdt. aceite + 1 vaso leche + 1 mandarina.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">1 manzana + 1 cda. chía.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Pescado vapor + 1 papa criolla + ensalada espinacas + 1 cda. aceite + 1 granadilla.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 yogur + 1 rebanada papaya.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Pechuga pavo + ½ pocillo pasta + ensalada pepino + 1 cdt. aceite + 1 durazno.</p></div>
                    </div>
                </div>
                <div class="card-element p-6">
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Sábado</h3>
                    <div class="space-y-4 text-sm">
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">Cereal integral (½ pocillo) + 1 vaso leche + 1 cda. miel + 1 banano.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">1 pera + 1 cda. almendras.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Carne ternera + ½ pocillo puré papa + ensalada zanahoria + 1 cda. aceite + 1 manzana.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 yogur + 12 fresas.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Omelette champiñones (1 huevo) + 1 tostada + 1 cdt. mantequilla + 1 mandarina.</p></div>
                    </div>
                </div>
                <div class="card-element p-6 md:col-span-2 lg:col-span-1"> 
                    <h3 class="text-2xl font-semibold text-sky-600 mb-4">Domingo</h3>
                    <div class="space-y-4 text-sm">
                        <div><h4 class="font-semibold text-sky-500">Desayuno:</h4><p class="text-gray-600">2 panqueques peq. (harina integral) + 1 cdt. miel + 1 vaso leche + 1 guayaba.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Mañana:</h4><p class="text-gray-600">1 mango pequeño + 1 cda. nueces.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Almuerzo:</h4><p class="text-gray-600">Pechuga plancha + ½ pocillo arroz + ensalada mixta + 1 cda. aceite + 1 rebanada piña.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Media Tarde:</h4><p class="text-gray-600">1 yogur + 7 uvas chilenas.</p></div>
                        <div><h4 class="font-semibold text-sky-500">Cena:</h4><p class="text-gray-600">Sopa lentejas + 1 arepa + 1 cdt. aceite + 1 pera.</p></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="lista-compras-base" class="mb-16 p-6 card-element">
            <h2 class="text-3xl md:text-4xl font-semibold text-sky-700 section-header">Lista de Compras Base (para Semana 1)</h2>
            <p class="text-gray-500 text-sm mb-6">Esta es una lista sugerida para cubrir el menú de ejemplo de la Semana 1 para 2 personas. Ajusta según tus necesidades.</p>
            <div class="grid gap-x-6 gap-y-4"> 
                <div>
                    <h4 class="text-xl font-semibold text-sky-600 mb-3">Frutas</h4>
                    <ul class="space-y-1.5 text-sm text-gray-600">
                        <li class="flex items-center"><input type="checkbox" id="baseFruta1" class="mr-2"><label for="baseFruta1">Bananos (3-4 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta2" class="mr-2"><label for="baseFruta2">Fresas (1 bandeja)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta3" class="mr-2"><label for="baseFruta3">Manzanas (3-4 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta4" class="mr-2"><label for="baseFruta4">Peras (3-4 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta5" class="mr-2"><label for="baseFruta5">Mandarinas (3-4 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta6" class="mr-2"><label for="baseFruta6">Naranja (1-2 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta7" class="mr-2"><label for="baseFruta7">Uvas (1 racimo pequeño)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta9" class="mr-2"><label for="baseFruta9">Piña (1/2 unidad)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta10" class="mr-2"><label for="baseFruta10">Papaya (1/2 mediana)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta11" class="mr-2"><label for="baseFruta11">Mango (1-2 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta12" class="mr-2"><label for="baseFruta12">Maracuyá (2 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta13" class="mr-2"><label for="baseFruta13">Duraznos (2 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta14" class="mr-2"><label for="baseFruta14">Guayabas (2 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta15" class="mr-2"><label for="baseFruta15">Ciruelas (4-5 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta16" class="mr-2"><label for="baseFruta16">Granadilla (1 unidad)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseFruta17" class="mr-2"><label for="baseFruta17">Aguacate (1/2 unidad)</label></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-600 mb-3">Verduras y Hortalizas</h4>
                    <ul class="space-y-1.5 text-sm text-gray-600">
                        <li class="flex items-center"><input type="checkbox" id="baseVer1" class="mr-2"><label for="baseVer1">Lechuga (1 unidad)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer2" class="mr-2"><label for="baseVer2">Tomate (3-4 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer3" class="mr-2"><label for="baseVer3">Zanahoria (1/2 kg)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer4" class="mr-2"><label for="baseVer4">Pepino (1 unidad)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer5" class="mr-2"><label for="baseVer5">Espinaca (1 atado)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer6" class="mr-2"><label for="baseVer6">Brócoli (1 unidad pequeña)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer7" class="mr-2"><label for="baseVer7">Remolacha (1 unidad)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer13" class="mr-2"><label for="baseVer13">Champiñones (1/2 bandeja)</label></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-600 mb-3">Proteínas y Lácteos</h4>
                    <ul class="space-y-1.5 text-sm text-gray-600">
                        <li class="flex items-center"><input type="checkbox" id="baseProt1" class="mr-2"><label for="baseProt1">Pechuga de pollo (aprox. 500g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt2" class="mr-2"><label for="baseProt2">Carne de res magra (aprox. 250g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt2a" class="mr-2"><label for="baseProt2a">Carne de cerdo magra (aprox. 250g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt2b" class="mr-2"><label for="baseProt2b">Carne de ternera (aprox. 250g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt3" class="mr-2"><label for="baseProt3">Pescado (filetes, aprox. 300g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt3a" class="mr-2"><label for="baseProt3a">Pechuga de pavo (aprox. 250g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt4" class="mr-2"><label for="baseProt4">Atún en agua (1 lata)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt5" class="mr-2"><label for="baseProt5">Huevos (6-8 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt6" class="mr-2"><label for="baseProt6">Jamón (100 g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt7" class="mr-2"><label for="baseProt7">Queso fresco/blanco (200 g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt8" class="mr-2"><label for="baseProt8">Yogur dietético/natural (4-5 unidades)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt9" class="mr-2"><label for="baseProt9">Leche semidescremada (1-2 litros)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseProt10" class="mr-2"><label for="baseProt10">Kumis dietético (1 unidad)</label></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-600 mb-3">Granos, Cereales y Tubérculos</h4>
                    <ul class="space-y-1.5 text-sm text-gray-600">
                        <li class="flex items-center"><input type="checkbox" id="baseGrano1" class="mr-2"><label for="baseGrano1">Arroz (blanco/integral, 1/2 kg)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano2" class="mr-2"><label for="baseGrano2">Quinua (100 g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano3" class="mr-2"><label for="baseGrano3">Lentejas (1/4 kg)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano4" class="mr-2"><label for="baseGrano4">Fríjoles (1/4 kg)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano6" class="mr-2"><label for="baseGrano6">Avena en hojuelas (1/4 kg)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano7" class="mr-2"><label for="baseGrano7">Pasta (integral preferiblemente, 250g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano8" class="mr-2"><label for="baseGrano8">Arepas de maíz (paquete pequeño)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano9" class="mr-2"><label for="baseGrano9">Pan integral (1 paquete tajado)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrano10" class="mr-2"><label for="baseGrano10">Cereal integral (1 caja pequeña)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer8" class="mr-2"><label for="baseVer8">Papa común (1 kg)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseVer9" class="mr-2"><label for="baseVer9">Papa criolla (1/2 kg)</label></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-600 mb-3">Grasas y Frutos Secos</h4>
                    <ul class="space-y-1.5 text-sm text-gray-600">
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa1" class="mr-2"><label for="baseGrasa1">Aceite de oliva (1 botella pequeña)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa2" class="mr-2"><label for="baseGrasa2">Aceite vegetal (opcional)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa3" class="mr-2"><label for="baseGrasa3">Mantequilla (1 barra pequeña)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa4" class="mr-2"><label for="baseGrasa4">Margarina (opcional)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa5" class="mr-2"><label for="baseGrasa5">Mayonesa light (1 frasco pequeño)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa6" class="mr-2"><label for="baseGrasa6">Almendras (100 g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa7" class="mr-2"><label for="baseGrasa7">Nueces (100 g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa8" class="mr-2"><label for="baseGrasa8">Maní (100 g)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa9" class="mr-2"><label for="baseGrasa9">Chía (paquete pequeño)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseGrasa10" class="mr-2"><label for="baseGrasa10">Ajonjolí (paquete pequeño)</label></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-sky-600 mb-3">Otros</h4>
                    <ul class="space-y-1.5 text-sm text-gray-600">
                        <li class="flex items-center"><input type="checkbox" id="baseOtro1" class="mr-2"><label for="baseOtro1">Miel (1 frasco pequeño)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseOtro3" class="mr-2"><label for="baseOtro3">Café/té</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseOtro4" class="mr-2"><label for="baseOtro4">Sal y especias (al gusto)</label></li>
                        <li class="flex items-center"><input type="checkbox" id="baseOtro5" class="mr-2"><label for="baseOtro5">Crema de leche (opcional, 1 bolsa pequeña)</label></li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="generador-menu" class="mb-12 p-6 card-element">
            <h2 class="text-3xl md:text-4xl font-semibold text-sky-700 section-header">Generador de Menús Semanales</h2>
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-8 gap-6 lg:gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto">
                    <label for="weekNumberInput" class="text-sky-700 font-semibold text-lg whitespace-nowrap">Semana #:</label>
                    <input type="number" id="weekNumberInput" value="2" min="1" class="custom-input w-full sm:w-24 text-center text-lg">
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-3 w-full lg:w-auto">
                    <label for="numPersonasInput" class="text-sky-700 font-semibold text-lg whitespace-nowrap">Personas:</label>
                    <input type="number" id="numPersonasInput" value="2" min="1" class="custom-input w-full sm:w-24 text-center text-lg">
                </div>
                <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto mt-4 sm:mt-0">
                    <button id="generateMenuBtn" class="custom-btn custom-btn-sky w-full sm:w-auto">
                        Generar Menú
                    </button>
                    <button id="loadMenuBtn" class="custom-btn custom-btn-slate w-full sm:w-auto">
                        Cargar Menú
                    </button>
                </div>
            </div>
            <div id="generatedWeekMenuContainer" class="mb-6">
                 <h3 id="generatedMenuTitle" class="text-2xl md:text-3xl font-semibold text-sky-600 mb-6 text-center"></h3>
                 <div id="generatedWeekMenu" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                 </div>
            </div>
            <div class="mt-8 text-center" id="shoppingListActions">
                <button id="generateShoppingListBtn" class="custom-btn custom-btn-teal w-full sm:w-auto md:w-1/2 lg:w-1/3" disabled>
                    Ver/Actualizar Lista de Compras
                </button>
            </div>
            <p id="menuMessage" class="text-center text-sky-600 mt-6 font-medium text-base"></p>
            
            <section id="generatedShoppingListSection" class="mt-10 pt-6 border-t border-sky-200" style="display: none;">
                <h3 class="text-2xl md:text-3xl font-semibold text-sky-700 mb-6 text-center">Lista de Compras para Menú Generado</h3>
                <div id="generatedShoppingListContainer" class="shopping-list-card bg-sky-50 p-6 rounded-lg grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-4 text-gray-700">
                </div>
                <p id="shoppingListMessage" class="text-center text-gray-600 mt-6 font-medium text-base"></p>
            </section>
        </section>

        <footer class="text-center mt-12 md:mt-16 py-8 border-t border-sky-300">
            <p class="text-sm text-sky-600">&copy; <span id="currentYear"></span> Planificador Nutricional Inteligente. Creado para tu bienestar.</p>
        </footer>
    </div>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', () => {
            const baseShoppingCheckboxes = document.querySelectorAll('#lista-compras-base input[type="checkbox"]');
            const baseShoppingListKeyPrefix = 'baseShoppingCheckboxState_'; 

            const loadBaseShoppingCheckboxStates = () => {
                baseShoppingCheckboxes.forEach(checkbox => {
                    const savedState = localStorage.getItem(baseShoppingListKeyPrefix + checkbox.id);
                    if (savedState !== null) checkbox.checked = savedState === 'true';
                });
            };
            const saveBaseShoppingCheckboxState = (checkbox) => {
                localStorage.setItem(baseShoppingListKeyPrefix + checkbox.id, checkbox.checked);
            };
            loadBaseShoppingCheckboxStates();
            baseShoppingCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => saveBaseShoppingCheckboxState(checkbox));
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const generateMenuBtn = document.getElementById('generateMenuBtn');
            const loadMenuBtn = document.getElementById('loadMenuBtn');
            const generateShoppingListBtn = document.getElementById('generateShoppingListBtn');
            const weekNumberInput = document.getElementById('weekNumberInput');
            const numPersonasInput = document.getElementById('numPersonasInput');
            const generatedWeekMenuDiv = document.getElementById('generatedWeekMenu');
            const menuMessageP = document.getElementById('menuMessage');
            const generatedMenuTitleH3 = document.getElementById('generatedMenuTitle');
            const generatedShoppingListSection = document.getElementById('generatedShoppingListSection');
            const generatedShoppingListContainer = document.getElementById('generatedShoppingListContainer');
            const shoppingListMessageP = document.getElementById('shoppingListMessage');
            
            let currentWeeklyMenu = null; 

            const guiaAlimentacion = {
                "Desayuno": { "Queso o sustituto": 2, "Harinas": 2, "Grasas": 1, "Frutas": 1 },
                "Media Mañana": { "Frutas": 1, "Nueces": 0.5 }, 
                "Almuerzo": { "Carnes": 1, "Harinas": 2, "Frutas": 1, "Verduras": 2, "Grasas": 2 }, 
                "Media Tarde": { "Leche semidescremada": 1, "Frutas": 0.5, "Nueces": 0.5 }, 
                "Cena": { "Carnes": 1, "Harinas": 1, "Verduras": 2, "Grasas": 1 } 
            };

            const alimentosPorGrupo = {
                "Frutas": [
                    { id: "fr01", nombre: "Banano", porcionTexto: "1/2 Pequeño", cantidadBase: 0.5, unidadBase: "unidad", categoriaCompra: "Frutas" },
                    { id: "fr02", nombre: "Ciruelas", porcionTexto: "2 Pequeñas", cantidadBase: 2, unidadBase: "unidades", categoriaCompra: "Frutas" },
                    { id: "fr03", nombre: "Durazno", porcionTexto: "1 Mediano", cantidadBase: 1, unidadBase: "unidad", categoriaCompra: "Frutas" },
                    { id: "fr04", nombre: "Fresas", porcionTexto: "1 pocillo (12-15 uds)", cantidadBase: 1, unidadBase: "pocillo", categoriaCompra: "Frutas" },
                    { id: "fr05", nombre: "Guayaba", porcionTexto: "1 Mediana", cantidadBase: 1, unidadBase: "unidad", categoriaCompra: "Frutas" },
                    { id: "fr06", nombre: "Mandarina", porcionTexto: "1 Grande o 2 peq.", cantidadBase: 1, unidadBase: "unidad grande", categoriaCompra: "Frutas" },
                    { id: "fr07", nombre: "Mango", porcionTexto: "1 Pequeño", cantidadBase: 1, unidadBase: "unidad pequeña", categoriaCompra: "Frutas" },
                    { id: "fr08", nombre: "Manzana", porcionTexto: "1 Pequeña/Mediana", cantidadBase: 1, unidadBase: "unidad", categoriaCompra: "Frutas" },
                    { id: "fr09", nombre: "Naranja", porcionTexto: "1 Mediana", cantidadBase: 1, unidadBase: "unidad", categoriaCompra: "Frutas" },
                    { id: "fr10", nombre: "Papaya", porcionTexto: "1 Tajada Mediana (1 pocillo)", cantidadBase: 1, unidadBase: "tajada mediana", categoriaCompra: "Frutas" },
                    { id: "fr11", nombre: "Pera", porcionTexto: "1 Mediana", cantidadBase: 1, unidadBase: "unidad", categoriaCompra: "Frutas" },
                    { id: "fr12", nombre: "Piña", porcionTexto: "1 Rebanada (1 pocillo trozos)", cantidadBase: 1, unidadBase: "rebanada", categoriaCompra: "Frutas" },
                    { id: "fr13", nombre: "Uvas (verdes/rojas)", porcionTexto: "1 pocillo (12-15 uds)", cantidadBase: 1, unidadBase: "pocillo", categoriaCompra: "Frutas" },
                    { id: "fr14", nombre: "Aguacate Hass", porcionTexto: "1/4 Unidad mediana", cantidadBase: 0.25, unidadBase: "unidad", categoriaCompra: "Frutas" } 
                ],
                "Harinas": [
                    { id: "ha01", nombre: "Arepa de maíz", porcionTexto: "1 Mediana (50-60g)", cantidadBase: 1, unidadBase: "unidad mediana", categoriaCompra: "Granos y Cereales" },
                    { id: "ha02", nombre: "Arroz cocido", porcionTexto: "1/2 Pocillo (90g)", cantidadBase: 90, unidadBase: "g", categoriaCompra: "Granos y Cereales" },
                    { id: "ha03", nombre: "Avena en hojuelas", porcionTexto: "1/2 Pocillo (30g cruda)", cantidadBase: 30, unidadBase: "g", categoriaCompra: "Granos y Cereales" },
                    { id: "ha04", nombre: "Galletas de soda/integrales", porcionTexto: "3-4 Unidades", cantidadBase: 4, unidadBase: "unidades", categoriaCompra: "Granos y Cereales" },
                    { id: "ha05", nombre: "Pasta cocida", porcionTexto: "1/2 Pocillo (70g cruda)", cantidadBase: 70, unidadBase: "g", categoriaCompra: "Granos y Cereales" },
                    { id: "ha06", nombre: "Pan integral", porcionTexto: "1 Tajada", cantidadBase: 1, unidadBase: "tajada", categoriaCompra: "Granos y Cereales" },
                    { id: "ha07", nombre: "Quinua cocida", porcionTexto: "1/2 Pocillo (85g cruda)", cantidadBase: 85, unidadBase: "g", categoriaCompra: "Granos y Cereales" },
                    { id: "ha08", nombre: "Papa común/pastusa", porcionTexto: "1 Mediana (150g)", cantidadBase: 150, unidadBase: "g", categoriaCompra: "Tubérculos" },
                    { id: "ha09", nombre: "Papa criolla", porcionTexto: "3-4 Medianas (150g)", cantidadBase: 150, unidadBase: "g", categoriaCompra: "Tubérculos" },
                    { id: "ha10", nombre: "Plátano (verde/maduro)", porcionTexto: "1/3 Unidad mediana (80g)", cantidadBase: 80, unidadBase: "g", categoriaCompra: "Tubérculos" },
                    { id: "ha11", nombre: "Yuca", porcionTexto: "1 Trozo pequeño (80g)", cantidadBase: 80, unidadBase: "g", categoriaCompra: "Tubérculos" },
                    { id: "ha12", nombre: "Fríjol cocido", porcionTexto: "1/2 Pocillo (90g cocido)", cantidadBase: 90, unidadBase: "g", categoriaCompra: "Legumbres" },
                    { id: "ha13", nombre: "Lenteja cocida", porcionTexto: "1/2 Pocillo (90g cocido)", cantidadBase: 90, unidadBase: "g", categoriaCompra: "Legumbres" },
                    { id: "ha14", nombre: "Garbanzo cocido", porcionTexto: "1/2 Pocillo (90g cocido)", cantidadBase: 90, unidadBase: "g", categoriaCompra: "Legumbres" }
                ],
                "Queso o sustituto": [
                    { id: "qs01", nombre: "Queso fresco/campesino", porcionTexto: "1 Tajada (30-40g)", cantidadBase: 35, unidadBase: "g", categoriaCompra: "Lácteos y Sustitutos" },
                    { id: "qs02", nombre: "Cuajada", porcionTexto: "1 Tajada (30-40g)", cantidadBase: 35, unidadBase: "g", categoriaCompra: "Lácteos y Sustitutos" },
                    { id: "qs03", nombre: "Huevo", porcionTexto: "1 Unidad", cantidadBase: 1, unidadBase: "unidad", categoriaCompra: "Proteínas" },
                    { id: "qs04", nombre: "Jamón de pavo/pollo", porcionTexto: "2 Tajadas (40g)", cantidadBase: 40, unidadBase: "g", categoriaCompra: "Proteínas" }
                ],
                "Carnes": [
                    { id: "ca01", nombre: "Pescado blanco", porcionTexto: "1 Filete (120-150g)", cantidadBase: 135, unidadBase: "g", categoriaCompra: "Proteínas" },
                    { id: "ca02", nombre: "Pescado azul", porcionTexto: "1 Filete (120-150g)", cantidadBase: 135, unidadBase: "g", categoriaCompra: "Proteínas" },
                    { id: "ca03", nombre: "Pollo (pechuga/muslo s/piel)", porcionTexto: "1 Presa (120-150g)", cantidadBase: 135, unidadBase: "g", categoriaCompra: "Proteínas" },
                    { id: "ca04", nombre: "Carne de res magra", porcionTexto: "1 Filete (100-120g)", cantidadBase: 110, unidadBase: "g", categoriaCompra: "Proteínas" },
                    { id: "ca05", nombre: "Cerdo (lomo magro)", porcionTexto: "1 Filete (100-120g)", cantidadBase: 110, unidadBase: "g", categoriaCompra: "Proteínas" },
                    { id: "ca06", nombre: "Atún en agua", porcionTexto: "1 Lata (90-120g drenado)", cantidadBase: 100, unidadBase: "g", categoriaCompra: "Proteínas" }
                ],
                "Grasas": [
                    { id: "gr01", nombre: "Aceite de oliva extra virgen", porcionTexto: "1 Cucharadita (5ml)", cantidadBase: 5, unidadBase: "ml", categoriaCompra: "Grasas y Aceites" },
                    { id: "gr02", nombre: "Mantequilla", porcionTexto: "1/2 Cucharadita (2.5g)", cantidadBase: 2.5, unidadBase: "g", categoriaCompra: "Grasas y Aceites" }
                ],
                "Leche semidescremada": [
                    { id: "la01", nombre: "Leche líquida semidescremada", porcionTexto: "1 Vaso (200-240ml)", cantidadBase: 220, unidadBase: "ml", categoriaCompra: "Lácteos y Sustitutos" },
                    { id: "la02", nombre: "Yogur natural sin azúcar/griego", porcionTexto: "1 Vaso/unidad (150-200g)", cantidadBase: 175, unidadBase: "g", categoriaCompra: "Lácteos y Sustitutos" },
                    { id: "la03", nombre: "Kumis dietético", porcionTexto: "1 Vaso (180-200ml)", cantidadBase: 190, unidadBase: "ml", categoriaCompra: "Lácteos y Sustitutos" }
                ],
                "Nueces": [ // Frutos secos para snacks
                    { id: "nu01", nombre: "Almendras naturales", porcionTexto: "10-12 Unidades (15g)", cantidadBase: 15, unidadBase: "g", categoriaCompra: "Frutos Secos" },
                    { id: "nu02", nombre: "Nueces del Brasil/nogal", porcionTexto: "3-4 Unidades (15g)", cantidadBase: 15, unidadBase: "g", categoriaCompra: "Frutos Secos" },
                    { id: "nu03", nombre: "Maní natural", porcionTexto: "1 Cucharada (15g)", cantidadBase: 15, unidadBase: "g", categoriaCompra: "Frutos Secos" },
                    { id: "nu04", nombre: "Semillas de girasol/calabaza", porcionTexto: "1 Cucharada (15g)", cantidadBase: 15, unidadBase: "g", categoriaCompra: "Frutos Secos" }
                ],
                "Verduras": [ // Porción general: 1 pocillo crudas de hoja, 1/2 pocillo cocidas densas
                    { id: "ve01", nombre: "Lechuga variada", porcionTexto: "1-2 Pocillos", cantidadBase: 1.5, unidadBase: "pocillos", categoriaCompra: "Verduras" },
                    { id: "ve02", nombre: "Tomate chonto/milano", porcionTexto: "1/2 Unidad mediana", cantidadBase: 0.5, unidadBase: "unidad", categoriaCompra: "Verduras" },
                    { id: "ve03", nombre: "Pepino cohombro", porcionTexto: "1/2 Unidad mediana", cantidadBase: 0.5, unidadBase: "unidad", categoriaCompra: "Verduras" },
                    { id: "ve04", nombre: "Espinaca", porcionTexto: "2 pocillos cruda / 1 cocida", cantidadBase: 1, unidadBase: "pocillo cocida", categoriaCompra: "Verduras" },
                    { id: "ve05", nombre: "Brócoli", porcionTexto: "1 Pocillo cocido", cantidadBase: 1, unidadBase: "pocillo cocido", categoriaCompra: "Verduras" },
                    { id: "ve06", nombre: "Coliflor", porcionTexto: "1 Pocillo cocido", cantidadBase: 1, unidadBase: "pocillo cocido", categoriaCompra: "Verduras" },
                    { id: "ve07", nombre: "Zanahoria", porcionTexto: "1/2 Pocillo rallada/picada", cantidadBase: 0.5, unidadBase: "pocillo", categoriaCompra: "Verduras" },
                    { id: "ve08", nombre: "Pimentón (rojo/verde/amarillo)", porcionTexto: "1/2 Unidad mediana", cantidadBase: 0.5, unidadBase: "unidad", categoriaCompra: "Verduras" },
                    { id: "ve09", nombre: "Calabacín", porcionTexto: "1 Pocillo en rodajas/cubos", cantidadBase: 1, unidadBase: "pocillo", categoriaCompra: "Verduras" },
                    { id: "ve10", nombre: "Berenjena", porcionTexto: "1 Pocillo en rodajas/cubos", cantidadBase: 1, unidadBase: "pocillo", categoriaCompra: "Verduras" },
                    { id: "ve11", nombre: "Champiñones", porcionTexto: "1 Pocillo laminados", cantidadBase: 1, unidadBase: "pocillo", categoriaCompra: "Verduras" },
                    { id: "ve12", nombre: "Cebolla cabezona", porcionTexto: "1/4 Unidad mediana en prep.", cantidadBase: 0.25, unidadBase: "unidad", categoriaCompra: "Verduras" },
                    { id: "ve13", nombre: "Habichuela", porcionTexto: "1/2 Pocillo cocida", cantidadBase: 0.5, unidadBase: "pocillo", categoriaCompra: "Verduras" }
                ]
            };
            
            function getRandomItem(arr) {
                if (!arr || arr.length === 0) return { id:"empty", nombre: "No disponible", porcionTexto: "", cantidadBase: 0, unidadBase: "", categoriaCompra: "Otros" };
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function getFoodItemById(id) {
                for (const group in alimentosPorGrupo) {
                    const found = alimentosPorGrupo[group].find(food => food.id === id);
                    if (found) return found;
                }
                return null;
            }


            function generateMeal(mealType, foodGuide, foodData) {
                const mealComposition = foodGuide[mealType];
                if (!mealComposition) return [];
                let mealDetailsObjects = [];

                for (const foodGroup in mealComposition) {
                    let portionsNeeded = mealComposition[foodGroup];
                    if (portionsNeeded === 0) continue;

                    const availableFoodsInGroup = foodData[foodGroup];
                    if (!availableFoodsInGroup || availableFoodsInGroup.length === 0) {
                        console.warn(`No hay alimentos disponibles para el grupo: ${foodGroup}`);
                        mealDetailsObjects.push({ id: `empty_${foodGroup}`, nombre: `${foodGroup} (No opciones)`, porcionTexto: "", isEmptyPlaceholder: true, categoriaCompra: "Otros" });
                        continue;
                    }
                    
                    let selectedFoodsForThisGroup = [];
                    for (let i = 0; i < Math.ceil(portionsNeeded); i++) {
                        let randomFood = getRandomItem(availableFoodsInGroup);
                        
                        // Evitar duplicados si es posible y hay más opciones
                        if (Math.ceil(portionsNeeded) > 1 && selectedFoodsForThisGroup.some(sf => sf.id === randomFood.id) && availableFoodsInGroup.length > selectedFoodsForThisGroup.length) {
                           let attempts = 0;
                           while(selectedFoodsForThisGroup.some(sf => sf.id === randomFood.id) && attempts < 5) { // Limitar intentos
                               randomFood = getRandomItem(availableFoodsInGroup);
                               attempts++;
                           }
                        }
                        // Crear una copia del objeto para no modificar el original, especialmente si se ajusta la cantidad para media porción
                        let foodToAdd = {...randomFood}; 

                        // Si la guía pide 0.5 porciones, y estamos en la primera (y única) iteración de Math.ceil(0.5) = 1
                        if (portionsNeeded < 1 && portionsNeeded > 0 && i === 0) {
                             // No es necesario modificar cantidadBase aquí, se maneja en la lista de compras.
                             // La porcionTexto ya debería reflejar la porción de la guía.
                        }
                        selectedFoodsForThisGroup.push(foodToAdd);
                    }
                    mealDetailsObjects.push(...selectedFoodsForThisGroup);
                }
                return mealDetailsObjects;
            }

            function generateFullWeeklyMenu() {
                const daysOfWeek = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
                const mealTypes = ["Desayuno", "Media Mañana", "Almuerzo", "Media Tarde", "Cena"];
                let weeklyMenu = {};
                daysOfWeek.forEach(day => {
                    weeklyMenu[day] = {};
                    mealTypes.forEach(mealType => {
                        weeklyMenu[day][mealType] = generateMeal(mealType, guiaAlimentacion, alimentosPorGrupo);
                    });
                });
                currentWeeklyMenu = weeklyMenu; 
                generateShoppingListBtn.disabled = false; 
                return weeklyMenu;
            }

            function displayGeneratedMenu(menuData, weekNum) {
                generatedWeekMenuDiv.innerHTML = ''; 
                generatedMenuTitleH3.textContent = `Menú Generado para la Semana ${weekNum}`;
                if (!menuData || Object.keys(menuData).length === 0) {
                    generatedWeekMenuDiv.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No hay menú para mostrar. Intenta generar uno.</p>';
                    generateShoppingListBtn.disabled = true;
                    return;
                }
                currentWeeklyMenu = menuData; 
                generateShoppingListBtn.disabled = false;

                const daysOrder = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
                daysOrder.forEach(day => {
                    if (menuData[day]) {
                        const dayMeals = menuData[day];
                        const dayCard = document.createElement('div');
                        dayCard.className = 'generated-meal-card card-element p-6';
                        let cardHTML = `<h3 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-5">${day}</h3><div class="space-y-5">`;
                        const mealOrder = ["Desayuno", "Media Mañana", "Almuerzo", "Media Tarde", "Cena"];
                        mealOrder.forEach(mealName => {
                            const mealItems = dayMeals[mealName];
                            if (mealItems && mealItems.length > 0 && !mealItems.some(item => item.isEmptyPlaceholder)) {
                                cardHTML += `<div><h4 class="text-sky-600">${mealName}:</h4><ul>`;
                                mealItems.forEach(item => {
                                    let displayText = `${item.nombre}`;
                                    const foodGroupKey = Object.keys(alimentosPorGrupo).find(key => alimentosPorGrupo[key].some(food => food.id === item.id));
                                    const portionsInGuide = foodGroupKey ? (guiaAlimentacion[mealName]?.[foodGroupKey] || 0) : 0;

                                    if (portionsInGuide < 1 && portionsInGuide > 0) {
                                        displayText += ` (media porción de ${item.porcionTexto})`;
                                    } else {
                                        displayText += ` (${item.porcionTexto})`;
                                    }
                                    cardHTML += `<li>${displayText}</li>`;
                                });
                                cardHTML += `</ul></div>`;
                            } else {
                                cardHTML += `<div><h4 class="text-sky-600">${mealName}:</h4><p class="text-gray-500 italic text-sm">No asignado o no aplica.</p></div>`;
                            }
                        });
                        cardHTML += `</div>`;
                        dayCard.innerHTML = cardHTML;
                        generatedWeekMenuDiv.appendChild(dayCard);
                    }
                });
            }
            
            function generateShoppingListForMenu(weeklyMenu, numPersonas) {
                if (!weeklyMenu) return null;
                const aggregatedList = {};

                Object.values(weeklyMenu).forEach(dayMeals => { // Lunes, Martes...
                    Object.entries(dayMeals).forEach(([mealType, mealItems]) => { // Desayuno, Almuerzo...
                        mealItems.forEach(item => {
                            if (item.isEmptyPlaceholder || typeof item.cantidadBase === 'undefined') return;

                            const foodGroupKey = Object.keys(alimentosPorGrupo).find(key => alimentosPorGrupo[key].some(food => food.id === item.id));
                            const portionsInGuide = foodGroupKey ? (guiaAlimentacion[mealType]?.[foodGroupKey] || 0) : 0;


                            const key = item.id; // Usar ID para agregar, ya que el nombre puede no ser único si hay variaciones
                            if (!aggregatedList[key]) {
                                aggregatedList[key] = {
                                    nombre: item.nombre,
                                    totalCantidad: 0,
                                    unidadBase: item.unidadBase,
                                    categoriaCompra: item.categoriaCompra || "Otros"
                                };
                            }
                            
                            let factorPorcion = 1;
                            if (portionsInGuide < 1 && portionsInGuide > 0) {
                                factorPorcion = portionsInGuide; // Ej: 0.5 para media porción
                            }
                            aggregatedList[key].totalCantidad += (item.cantidadBase * factorPorcion);
                        });
                    });
                });

                const finalShoppingList = {};
                Object.values(aggregatedList).forEach(item => {
                    const categoria = item.categoriaCompra;
                    if (!finalShoppingList[categoria]) {
                        finalShoppingList[categoria] = [];
                    }
                    const cantidadTotalPersonas = item.totalCantidad * numPersonas;
                    const cantidadRedondeada = Math.ceil(cantidadTotalPersonas * 10) / 10; // Redondear hacia arriba para no quedarse corto

                    // Consolidar items con el mismo nombre y unidad
                    let existingItem = finalShoppingList[categoria].find(i => i.nombre === item.nombre && i.unidad === item.unidadBase);
                    if (existingItem) {
                        existingItem.cantidad = Math.ceil((existingItem.cantidad + cantidadRedondeada) * 10) / 10;
                    } else {
                         finalShoppingList[categoria].push({
                            nombre: item.nombre,
                            cantidad: cantidadRedondeada,
                            unidad: item.unidadBase
                        });
                    }
                });
                return finalShoppingList;
            }

            function displayShoppingList(shoppingListData, numPersonas) {
                generatedShoppingListContainer.innerHTML = '';
                shoppingListMessageP.textContent = `Lista de compras para ${numPersonas} persona(s) para la semana seleccionada.`;
                if (!shoppingListData || Object.keys(shoppingListData).length === 0) {
                    generatedShoppingListContainer.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">No hay datos para la lista de compras o el menú está vacío.</p>';
                    generatedShoppingListSection.style.display = 'block';
                    return;
                }

                const categoriesOrder = ["Frutas", "Verduras", "Proteínas", "Lácteos y Sustitutos", "Granos y Cereales", "Tubérculos", "Legumbres", "Frutos Secos", "Grasas y Aceites", "Otros"];

                categoriesOrder.forEach(category => {
                    if (shoppingListData[category] && shoppingListData[category].length > 0) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'mb-4';
                        let categoryHTML = `<h5 class="text-lg font-semibold text-sky-700 mb-2 border-b border-sky-200 pb-1">${category}</h5><ul>`;
                        shoppingListData[category].forEach(item => {
                             // No mostrar items con cantidad 0
                            if (item.cantidad > 0) {
                                categoryHTML += `<li>${item.nombre}: ${item.cantidad} ${item.unidad}</li>`;
                            }
                        });
                        categoryHTML += `</ul>`;
                        // Solo añadir la categoría si tiene items visibles
                        if (categoryHTML.includes("<li>")) {
                           categoryDiv.innerHTML = categoryHTML;
                           generatedShoppingListContainer.appendChild(categoryDiv);
                        }
                    }
                });
                generatedShoppingListSection.style.display = 'block';
            }

            function saveMenuToLocalStorage(weekNum, menu) {
                try {
                    localStorage.setItem(`generatedMenu_week${weekNum}`, JSON.stringify(menu));
                    menuMessageP.textContent = `Menú para la semana ${weekNum} guardado localmente.`;
                    menuMessageP.className = 'text-center text-green-600 mt-6 font-medium text-base';
                } catch (e) {
                    console.error("Error al guardar menú en localStorage:", e);
                    menuMessageP.textContent = `Error al guardar menú. Almacenamiento lleno?`;
                    menuMessageP.className = 'text-center text-red-600 mt-6 font-medium text-base';
                }
            }

            function loadMenuFromLocalStorage(weekNum) {
                const savedMenu = localStorage.getItem(`generatedMenu_week${weekNum}`);
                if (savedMenu) {
                    menuMessageP.textContent = `Menú para la semana ${weekNum} cargado.`;
                    menuMessageP.className = 'text-center text-sky-600 mt-6 font-medium text-base';
                    return JSON.parse(savedMenu);
                }
                menuMessageP.textContent = `No se encontró menú guardado para la semana ${weekNum}.`;
                menuMessageP.className = 'text-center text-amber-600 mt-6 font-medium text-base';
                return null;
            }

            function saveShoppingListToLocalStorage(weekNum, shoppingList) {
                try {
                    localStorage.setItem(`shoppingList_week${weekNum}`, JSON.stringify(shoppingList));
                } catch (e) {
                    console.error("Error al guardar lista de compras en localStorage:", e);
                }
            }

            function loadShoppingListFromLocalStorage(weekNum) {
                const savedList = localStorage.getItem(`shoppingList_week${weekNum}`);
                return savedList ? JSON.parse(savedList) : null;
            }

            generateMenuBtn.addEventListener('click', () => {
                const weekNum = weekNumberInput.value;
                if (!weekNum || weekNum < 1) {
                    menuMessageP.textContent = "Por favor, ingrese un número de semana válido (mayor o igual a 1).";
                    menuMessageP.className = 'text-center text-red-600 mt-6 font-medium text-base';
                    return;
                }
                menuMessageP.textContent = `Generando menú para la semana ${weekNum}...`;
                menuMessageP.className = 'text-center text-sky-600 mt-6 font-medium text-base animate-pulse';
                generatedShoppingListSection.style.display = 'none'; 
                
                setTimeout(() => { 
                    const newMenu = generateFullWeeklyMenu();
                    displayGeneratedMenu(newMenu, weekNum);
                    saveMenuToLocalStorage(weekNum, newMenu);
                    localStorage.removeItem(`shoppingList_week${weekNum}`); 
                    menuMessageP.classList.remove('animate-pulse');
                    shoppingListMessageP.textContent = "Presiona 'Ver/Actualizar Lista de Compras' para la nueva lista.";
                    shoppingListMessageP.className = 'text-center text-gray-500 mt-4 font-medium';
                }, 150);
            });

            loadMenuBtn.addEventListener('click', () => {
                const weekNum = weekNumberInput.value;
                 if (!weekNum || weekNum < 1) {
                    menuMessageP.textContent = "Por favor, ingrese un número de semana válido para cargar.";
                    menuMessageP.className = 'text-center text-red-600 mt-6 font-medium text-base';
                    return;
                }
                const loadedMenu = loadMenuFromLocalStorage(weekNum);
                if (loadedMenu) {
                    displayGeneratedMenu(loadedMenu, weekNum);
                    const loadedShoppingList = loadShoppingListFromLocalStorage(weekNum);
                    if (loadedShoppingList) {
                        const numPersonas = parseInt(numPersonasInput.value) || 2; 
                        displayShoppingList(loadedShoppingList, numPersonas);
                        shoppingListMessageP.textContent = `Lista de compras para ${numPersonas} persona(s) cargada para la semana ${weekNum}.`;
                        shoppingListMessageP.className = 'text-center text-sky-600 mt-4 font-medium';
                    } else {
                        generatedShoppingListSection.style.display = 'none';
                        shoppingListMessageP.textContent = "No hay lista de compras guardada para este menú. Puedes generarla.";
                         shoppingListMessageP.className = 'text-center text-gray-500 mt-4 font-medium';
                    }
                } else {
                    generatedWeekMenuDiv.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No hay menú guardado para esta semana. Intenta generar uno.</p>'; 
                    generatedMenuTitleH3.textContent = '';
                    currentWeeklyMenu = null;
                    generateShoppingListBtn.disabled = true;
                    generatedShoppingListSection.style.display = 'none';
                }
            });

            generateShoppingListBtn.addEventListener('click', () => {
                if (!currentWeeklyMenu) {
                    shoppingListMessageP.textContent = "Primero genera o carga un menú semanal.";
                    shoppingListMessageP.className = 'text-center text-red-600 mt-4 font-medium';
                    generatedShoppingListSection.style.display = 'block'; 
                    generatedShoppingListContainer.innerHTML = ''; 
                    return;
                }
                const numPersonas = parseInt(numPersonasInput.value);
                if (isNaN(numPersonas) || numPersonas < 1) {
                    shoppingListMessageP.textContent = "Por favor, ingrese un número válido de personas.";
                     shoppingListMessageP.className = 'text-center text-red-600 mt-4 font-medium';
                    generatedShoppingListSection.style.display = 'block';
                    return;
                }
                
                shoppingListMessageP.textContent = "Generando lista de compras...";
                shoppingListMessageP.className = 'text-center text-teal-600 mt-4 font-medium animate-pulse';
                generatedShoppingListSection.style.display = 'block';

                setTimeout(() => {
                    const shoppingList = generateShoppingListForMenu(currentWeeklyMenu, numPersonas);
                    displayShoppingList(shoppingList, numPersonas);
                    const weekNum = weekNumberInput.value;
                    saveShoppingListToLocalStorage(weekNum, shoppingList);
                    shoppingListMessageP.classList.remove('animate-pulse');
                    if(shoppingList && Object.keys(shoppingList).length > 0 && Object.values(shoppingList).some(cat => cat.length > 0)) {
                         shoppingListMessageP.textContent = `Lista de compras para ${numPersonas} persona(s) generada y guardada para la semana ${weekNum}.`;
                         shoppingListMessageP.className = 'text-center text-green-600 mt-4 font-medium';
                    } else {
                        shoppingListMessageP.textContent = `No se pudieron generar items para la lista de compras. Verifica el menú.`;
                        shoppingListMessageP.className = 'text-center text-amber-600 mt-4 font-medium';
                    }
                }, 150);
            });
        });
    </script>
</body>
</html>
